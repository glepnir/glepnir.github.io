<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><title>Go Context Package Usage | glepnir</title><link rel=stylesheet href=/css/reset.css><link rel=stylesheet href=/css/font.css><link rel=stylesheet href=/css/smigle.css><link rel=stylesheet href=/css/syntax.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><header><div id=brand><a class=icon-link href=https://yupdo.org><img class=icon src=/images/avatar.svg></a><div class=text><a href=https://yupdo.org><h1>glepnir</h1></a><h3>A vimer work at neovim team and other open source project.</h3></div></div><nav><a href=/><b>Home</b></a>
|
<a href=/posts/><b>Posts</b></a>
|
<a href=/donate/><b>Donate</b></a>
|
<a href=/categories/><b>Categories</b></a>
|
<a href=/tags/><b>Tags</b></a>
|
<a href=/about/><b>About</b></a></nav><hr></header><div id=content><main><article><h1>Go Context Package Usage</h1><div class=post-meta><strong><span>Posted on</span>
<time>2022-09-06</time></strong>
<span>• 785 words</span>
<span>• 4 minute read</span><div><span>Tags:</span>
<a href=/tags/go>go</a></div></div><div><h2 id=intro>Intro</h2><p>For the longest time I have wanted to see an easy to understand example (read newbie) of how to add data to the “new” golang 1.7 request context object. Since I wasted more than 2 days looking for something like that and never really found anything I decided to figure it out from the docs and write something up for others like me that wanted something simple. The example below is trivial and does not put anything useful in the context it’s just there to get your own juices flowing.</p><p>Let’s start with the main function that will really only create the router and the routes.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> main() {
</span></span><span style=display:flex><span>	mux := http.NewServeMux()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.Println(<span style=color:#0ff;font-weight:700>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	log.Fatal(http.ListenAndServe(<span style=color:#0ff;font-weight:700>&#34;:8085&#34;</span>, mux))
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>Our example will allow you to login and logout and once logged in we will put a “hardcoded” username in the context to flow to the StatusPage handler. So this is 3 routes:</p><ul><li>/login</li><li>/logout</li><li>/</li></ul><p>Login and Logout are simply done by visiting the route where we add and remove a cookie. Now to cerate the skeletons of the 3 handlers:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> StatusPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;This Page will show the context username once the context is added.&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LoginPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().Add(<span style=color:#ff0;font-weight:700>365</span> * <span style=color:#ff0;font-weight:700>24</span> * time.Hour)  <span style=color:#007f7f>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LogoutPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().AddDate(<span style=color:#ff0;font-weight:700>0</span>, <span style=color:#ff0;font-weight:700>0</span>, -<span style=color:#ff0;font-weight:700>1</span>)	<span style=color:#007f7f>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now the fun part to add context to the requests… First we’ll need to create middleware and use it in the router. Middleware is simply a function that accepts an http handler and returns an http.handler. In this simple example I will call the middleware component “AddContext” and in the returned handler I will first check to make sure we are logged by looking for the login cookie and if it is set then we place the data we want in the request’s context and call the next handler which was passed in as an argument…</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> AddContext(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#fff;font-weight:700>return</span> http.HandlerFunc(<span style=color:#fff;font-weight:700>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		log.Println(r.Method, <span style=color:#0ff;font-weight:700>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ := r.Cookie(<span style=color:#0ff;font-weight:700>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#fff;font-weight:700>if</span> cookie != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#007f7f>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>			ctx := context.WithValue(r.Context(), <span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r.WithContext(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As well we need to use that new middleware in the router and we do that in 1 or 2 ways…</p><p>First we can add the context only to specific routes, like so:</p><ul><li>mux.HandleFunc(“/”, StatusPage)</li></ul><p>becomes:</p><ul><li>mux.Handle(“/”, AddContext(http.HandlerFunc(StatusPage)))</li></ul><p>Or second, we can add it to the router itself:</p><ul><li>log.Println(“Start server on port :8085”)</li><li>log.Fatal(http.ListenAndServe(”:8085”, mux))</li></ul><p>becomes</p><ul><li>log.Println(“Start server on port :8085”)</li><li>contextedMux := AddContext(mux)</li><li>log.Fatal(http.ListenAndServe(”:8085”, contextedMux))
Once you have done all this we can now modify the ‘StatusPage’ handler to look for and react to the data that is now in the context.</li></ul><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> StatusPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#007f7f>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	<span style=color:#fff;font-weight:700>if</span> username := r.Context().Value(<span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>); username != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusOK)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Hello &#34;</span> + username.(<span style=color:#fff;font-weight:700>string</span>) + <span style=color:#0ff;font-weight:700>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It’s good to note that once we get the data out of the context we need to (cast) it to the proper type to use it. This is because the context Value() function returns an interface{} type. ( – See: ‘username.(string)’ )</p><p>I hope this quick intro to usign the Context object is useful, also I might write in the future about context With Cancel, Deadline and Timeout as they can also be useful in many scenarios.</p><p>Check out the entire code for this article below…</p><p>Happy GOing!!</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> AddContext(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#fff;font-weight:700>return</span> http.HandlerFunc(<span style=color:#fff;font-weight:700>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		log.Println(r.Method, <span style=color:#0ff;font-weight:700>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ := r.Cookie(<span style=color:#0ff;font-weight:700>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#fff;font-weight:700>if</span> cookie != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#007f7f>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>			ctx := context.WithValue(r.Context(), <span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r.WithContext(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> StatusPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#007f7f>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	<span style=color:#fff;font-weight:700>if</span> username := r.Context().Value(<span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>); username != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusOK)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Hello &#34;</span> + username.(<span style=color:#fff;font-weight:700>string</span>) + <span style=color:#0ff;font-weight:700>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LoginPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().Add(<span style=color:#ff0;font-weight:700>365</span> * <span style=color:#ff0;font-weight:700>24</span> * time.Hour)  <span style=color:#007f7f>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LogoutPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().AddDate(<span style=color:#ff0;font-weight:700>0</span>, <span style=color:#ff0;font-weight:700>0</span>, -<span style=color:#ff0;font-weight:700>1</span>)	<span style=color:#007f7f>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> main() {
</span></span><span style=display:flex><span>	mux := http.NewServeMux()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.Println(<span style=color:#0ff;font-weight:700>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	contextedMux := AddContext(mux)
</span></span><span style=display:flex><span>	log.Fatal(http.ListenAndServe(<span style=color:#0ff;font-weight:700>&#34;:8085&#34;</span>, contextedMux))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article></main><script src=https://utteranc.es/client.js repo=glepnir/glepnir.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div><footer><hr><p id=social>Find me around the web:<br><a href=https://github.com/glepnir>GitHub</a>
|
<a href=https://space.bilibili.com/321783076>Bilibili</a></p><p class=copyright>Copyright © 2023
<a href=https://yupdo.org><strong>glepnir</strong></a>.
This work is licensed under the
<a href=http://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> license.</p></footer></body></html>