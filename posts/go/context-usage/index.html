<!doctype html><html xmlns=http://www.w2.org/1999/xhtml><html lang=en><head><meta charset=utf-8><title>glepnir blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="personal blog"><meta property="og:title" content="glepnir blog"><meta property="og:type" content="website"><meta property="og:url" content="https://yupdo.org"><link rel=sitemap type=application/xml title=Sitemap href><link rel=canonical href=https://yupdo.org/posts/go/context-usage/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><script src=https://cdn.jsdelivr.net/npm/jquery></script>
<script src=/js/jquery.terminal.min.js></script>
<script src=https://unpkg.com/jquery.terminal/js/autocomplete_menu.js></script>
<link rel=stylesheet href=/css/terminal.css><link rel=stylesheet href=/css/font.css><link rel=stylesheet href=/css/modern.css><style>body{width:100%;font-size:24px}</style></head><body><section id=main><h1 id=title>Go Context Package Usage</h1><div><article id=content><h2 id=intro>Intro</h2><p>For the longest time I have wanted to see an easy to understand example (read newbie) of how to add data to the “new” golang 1.7 request context object. Since I wasted more than 2 days looking for something like that and never really found anything I decided to figure it out from the docs and write something up for others like me that wanted something simple. The example below is trivial and does not put anything useful in the context it’s just there to get your own juices flowing.</p><p>Let’s start with the main function that will really only create the router and the routes.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> main() {
</span></span><span style=display:flex><span>	mux := http.NewServeMux()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.Println(<span style=color:#0ff;font-weight:700>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	log.Fatal(http.ListenAndServe(<span style=color:#0ff;font-weight:700>&#34;:8085&#34;</span>, mux))
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>Our example will allow you to login and logout and once logged in we will put a “hardcoded” username in the context to flow to the StatusPage handler. So this is 3 routes:</p><ul><li>/login</li><li>/logout</li><li>/</li></ul><p>Login and Logout are simply done by visiting the route where we add and remove a cookie. Now to cerate the skeletons of the 3 handlers:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> StatusPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;This Page will show the context username once the context is added.&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LoginPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().Add(<span style=color:#ff0;font-weight:700>365</span> * <span style=color:#ff0;font-weight:700>24</span> * time.Hour)  <span style=color:#007f7f>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LogoutPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().AddDate(<span style=color:#ff0;font-weight:700>0</span>, <span style=color:#ff0;font-weight:700>0</span>, -<span style=color:#ff0;font-weight:700>1</span>)	<span style=color:#007f7f>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now the fun part to add context to the requests… First we’ll need to create middleware and use it in the router. Middleware is simply a function that accepts an http handler and returns an http.handler. In this simple example I will call the middleware component “AddContext” and in the returned handler I will first check to make sure we are logged by looking for the login cookie and if it is set then we place the data we want in the request’s context and call the next handler which was passed in as an argument…</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> AddContext(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#fff;font-weight:700>return</span> http.HandlerFunc(<span style=color:#fff;font-weight:700>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		log.Println(r.Method, <span style=color:#0ff;font-weight:700>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ := r.Cookie(<span style=color:#0ff;font-weight:700>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#fff;font-weight:700>if</span> cookie != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#007f7f>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>			ctx := context.WithValue(r.Context(), <span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r.WithContext(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As well we need to use that new middleware in the router and we do that in 1 or 2 ways…</p><p>First we can add the context only to specific routes, like so:</p><ul><li>mux.HandleFunc(“/”, StatusPage)</li></ul><p>becomes:</p><ul><li>mux.Handle(“/”, AddContext(http.HandlerFunc(StatusPage)))</li></ul><p>Or second, we can add it to the router itself:</p><ul><li>log.Println(“Start server on port :8085”)</li><li>log.Fatal(http.ListenAndServe(”:8085”, mux))</li></ul><p>becomes</p><ul><li>log.Println(“Start server on port :8085”)</li><li>contextedMux := AddContext(mux)</li><li>log.Fatal(http.ListenAndServe(”:8085”, contextedMux))
Once you have done all this we can now modify the ‘StatusPage’ handler to look for and react to the data that is now in the context.</li></ul><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> StatusPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#007f7f>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	<span style=color:#fff;font-weight:700>if</span> username := r.Context().Value(<span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>); username != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusOK)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Hello &#34;</span> + username.(<span style=color:#fff;font-weight:700>string</span>) + <span style=color:#0ff;font-weight:700>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It’s good to note that once we get the data out of the context we need to (cast) it to the proper type to use it. This is because the context Value() function returns an interface{} type. ( – See: ‘username.(string)’ )</p><p>I hope this quick intro to usign the Context object is useful, also I might write in the future about context With Cancel, Deadline and Timeout as they can also be useful in many scenarios.</p><p>Check out the entire code for this article below…</p><p>Happy GOing!!</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#0ff;font-weight:700>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> AddContext(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#fff;font-weight:700>return</span> http.HandlerFunc(<span style=color:#fff;font-weight:700>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		log.Println(r.Method, <span style=color:#0ff;font-weight:700>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ := r.Cookie(<span style=color:#0ff;font-weight:700>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#fff;font-weight:700>if</span> cookie != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#007f7f>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>			ctx := context.WithValue(r.Context(), <span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r.WithContext(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>			next.ServeHTTP(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> StatusPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#007f7f>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	<span style=color:#fff;font-weight:700>if</span> username := r.Context().Value(<span style=color:#0ff;font-weight:700>&#34;Username&#34;</span>); username != <span style=color:#fff;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusOK)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Hello &#34;</span> + username.(<span style=color:#fff;font-weight:700>string</span>) + <span style=color:#0ff;font-weight:700>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#fff;font-weight:700>else</span> {
</span></span><span style=display:flex><span>		w.WriteHeader(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.Write([]<span style=color:#fff;font-weight:700>byte</span>(<span style=color:#0ff;font-weight:700>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LoginPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().Add(<span style=color:#ff0;font-weight:700>365</span> * <span style=color:#ff0;font-weight:700>24</span> * time.Hour)  <span style=color:#007f7f>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> LogoutPage(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>	expiration := time.Now().AddDate(<span style=color:#ff0;font-weight:700>0</span>, <span style=color:#ff0;font-weight:700>0</span>, -<span style=color:#ff0;font-weight:700>1</span>)	<span style=color:#007f7f>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span>	cookie := http.Cookie{Name: <span style=color:#0ff;font-weight:700>&#34;username&#34;</span>, Value: <span style=color:#0ff;font-weight:700>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.SetCookie(w, &amp;cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>func</span> main() {
</span></span><span style=display:flex><span>	mux := http.NewServeMux()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.HandleFunc(<span style=color:#0ff;font-weight:700>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.Println(<span style=color:#0ff;font-weight:700>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	contextedMux := AddContext(mux)
</span></span><span style=display:flex><span>	log.Fatal(http.ListenAndServe(<span style=color:#0ff;font-weight:700>&#34;:8085&#34;</span>, contextedMux))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article></div></section><aside id=meta><div><section><h4 id=date>Tue Sep 6, 2022</h4><h5 id=wordcount>785 Words</h5></section><ul id=tags><li><a href=/tags/go/>go</a></li></ul></div><div><a class=previous href=https://yupdo.org/posts/algorithm/binarysearch/>Binarysearch</a>
<a class=next href=https://yupdo.org/posts/go/go-decorator-json/>Go Decorator Json</a></div></aside></body></html>