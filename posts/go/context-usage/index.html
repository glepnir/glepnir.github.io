<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>glepnir/posts/go/context-usage/</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=https://glepnir.neovim.pro/console-plus/css/terminal-0.7.2.min.css><link rel=stylesheet href=https://glepnir.neovim.pro/console-plus/css/animate-4.1.1.min.css><link rel=stylesheet href=https://glepnir.neovim.pro/console-plus/css/console.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><meta property="og:title" content="Go Context Package Usage"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://glepnir.neovim.pro/posts/go/context-usage/"><meta property="article:published_time" content="2022-09-06T16:38:23+08:00"><meta name=twitter:title content="Go Context Package Usage"><meta name=twitter:description content="Intro
For the longest time I have wanted to see an easy to understand example (read newbie) of how to add data to the “new” golang 1.7 request context object. Since I wasted more than 2 days looking for something like that and never really found anything I decided to figure it out from the docs and write something up for others like me that wanted something simple. The example below is trivial and does not put anything useful in the context it’s just there to get your own juices flowing."></head><body class=terminal><div class=container><div class=terminal-nav><header class=terminal-logo><div class="logo terminal-prompt"><a href=https://glepnir.neovim.pro/ class="no-style site-name">glepnir</a>:~#
<a href=https://glepnir.neovim.pro/posts>posts</a>/<a href=https://glepnir.neovim.pro/posts/go>go</a>/<a href=https://glepnir.neovim.pro/posts/go/context-usage>context-usage</a>/</div></header><nav class=terminal-menu><ul vocab="https://schema.org/" typeof="BreadcrumbList"><li><a href=https://glepnir.neovim.pro/posts/ typeof="ListItem">posts/</a></li><li><a href=https://glepnir.neovim.pro/tags/ typeof="ListItem">tags/</a></li><li><a href=https://glepnir.neovim.pro/about/ typeof="ListItem">about/</a></li><li><a href=https://glepnir.neovim.pro/sponsor/ typeof="ListItem">sponsor/</a></li></ul></nav></div></div><div class="container animated zoomIn fast"><h1>Go Context Package Usage</h1>Sep. 6, 2022<br><br><h2 id=intro>Intro</h2><p>For the longest time I have wanted to see an easy to understand example (read newbie) of how to add data to the “new” golang 1.7 request context object. Since I wasted more than 2 days looking for something like that and never really found anything I decided to figure it out from the docs and write something up for others like me that wanted something simple. The example below is trivial and does not put anything useful in the context it’s just there to get your own juices flowing.</p><p>Let’s start with the main function that will really only create the router and the routes.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>main</span>() {
</span></span><span style=display:flex><span>	mux <span style=color:#fe8019>:=</span> http.<span style=color:#fabd2f>NewServeMux</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.<span style=color:#fabd2f>HandleFunc</span>(<span style=color:#b8bb26>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#fabd2f>HandleFunc</span>(<span style=color:#b8bb26>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#fabd2f>HandleFunc</span>(<span style=color:#b8bb26>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.<span style=color:#fabd2f>Println</span>(<span style=color:#b8bb26>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	log.<span style=color:#fabd2f>Fatal</span>(http.<span style=color:#fabd2f>ListenAndServe</span>(<span style=color:#b8bb26>&#34;:8085&#34;</span>, mux))
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>Our example will allow you to login and logout and once logged in we will put a “hardcoded” username in the context to flow to the StatusPage handler. So this is 3 routes:</p><ul><li>/login</li><li>/logout</li><li>/</li></ul><p>Login and Logout are simply done by visiting the route where we add and remove a cookie. Now to cerate the skeletons of the 3 handlers:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>StatusPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	w.<span style=color:#fabd2f>Write</span>([]<span style=color:#fabd2f>byte</span>(<span style=color:#b8bb26>&#34;This Page will show the context username once the context is added.&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>LoginPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#fe8019>:=</span> time.<span style=color:#fabd2f>Now</span>().<span style=color:#fabd2f>Add</span>(<span style=color:#d3869b>365</span> <span style=color:#fe8019>*</span> <span style=color:#d3869b>24</span> <span style=color:#fe8019>*</span> time.Hour)  <span style=color:#928374;font-style:italic>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>	cookie <span style=color:#fe8019>:=</span> http.Cookie{Name: <span style=color:#b8bb26>&#34;username&#34;</span>, Value: <span style=color:#b8bb26>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#fabd2f>SetCookie</span>(w, <span style=color:#fe8019>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>LogoutPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#fe8019>:=</span> time.<span style=color:#fabd2f>Now</span>().<span style=color:#fabd2f>AddDate</span>(<span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#fe8019>-</span><span style=color:#d3869b>1</span>)	<span style=color:#928374;font-style:italic>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>	cookie <span style=color:#fe8019>:=</span> http.Cookie{Name: <span style=color:#b8bb26>&#34;username&#34;</span>, Value: <span style=color:#b8bb26>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#fabd2f>SetCookie</span>(w, <span style=color:#fe8019>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now the fun part to add context to the requests… First we’ll need to create middleware and use it in the router. Middleware is simply a function that accepts an http handler and returns an http.handler. In this simple example I will call the middleware component “AddContext” and in the returned handler I will first check to make sure we are logged by looking for the login cookie and if it is set then we place the data we want in the request’s context and call the next handler which was passed in as an argument…</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>AddContext</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#fe8019>return</span> http.<span style=color:#fabd2f>HandlerFunc</span>(<span style=color:#fe8019>func</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>		log.<span style=color:#fabd2f>Println</span>(r.Method, <span style=color:#b8bb26>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ <span style=color:#fe8019>:=</span> r.<span style=color:#fabd2f>Cookie</span>(<span style=color:#b8bb26>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#fe8019>if</span> cookie <span style=color:#fe8019>!=</span> <span style=color:#fe8019>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#928374;font-style:italic>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>			ctx <span style=color:#fe8019>:=</span> context.<span style=color:#fabd2f>WithValue</span>(r.<span style=color:#fabd2f>Context</span>(), <span style=color:#b8bb26>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.<span style=color:#fabd2f>ServeHTTP</span>(w, r.<span style=color:#fabd2f>WithContext</span>(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span>			next.<span style=color:#fabd2f>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As well we need to use that new middleware in the router and we do that in 1 or 2 ways…</p><p>First we can add the context only to specific routes, like so:</p><ul><li>mux.HandleFunc(“/”, StatusPage)</li></ul><p>becomes:</p><ul><li>mux.Handle(“/”, AddContext(http.HandlerFunc(StatusPage)))</li></ul><p>Or second, we can add it to the router itself:</p><ul><li>log.Println(“Start server on port :8085”)</li><li>log.Fatal(http.ListenAndServe(”:8085”, mux))</li></ul><p>becomes</p><ul><li>log.Println(“Start server on port :8085”)</li><li>contextedMux := AddContext(mux)</li><li>log.Fatal(http.ListenAndServe(”:8085”, contextedMux))
Once you have done all this we can now modify the ‘StatusPage’ handler to look for and react to the data that is now in the context.</li></ul><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>StatusPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#928374;font-style:italic>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>	<span style=color:#fe8019>if</span> username <span style=color:#fe8019>:=</span> r.<span style=color:#fabd2f>Context</span>().<span style=color:#fabd2f>Value</span>(<span style=color:#b8bb26>&#34;Username&#34;</span>); username <span style=color:#fe8019>!=</span> <span style=color:#fe8019>nil</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>Write</span>([]<span style=color:#fabd2f>byte</span>(<span style=color:#b8bb26>&#34;Hello &#34;</span> <span style=color:#fe8019>+</span> username.(<span style=color:#fabd2f>string</span>) <span style=color:#fe8019>+</span> <span style=color:#b8bb26>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>WriteHeader</span>(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>Write</span>([]<span style=color:#fabd2f>byte</span>(<span style=color:#b8bb26>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It’s good to note that once we get the data out of the context we need to (cast) it to the proper type to use it. This is because the context Value() function returns an interface{} type. ( – See: ‘username.(string)’ )</p><p>I hope this quick intro to usign the Context object is useful, also I might write in the future about context With Cancel, Deadline and Timeout as they can also be useful in many scenarios.</p><p>Check out the entire code for this article below…</p><p>Happy GOing!!</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#b8bb26>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b8bb26>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b8bb26>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#b8bb26>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>AddContext</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#fe8019>return</span> http.<span style=color:#fabd2f>HandlerFunc</span>(<span style=color:#fe8019>func</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>		log.<span style=color:#fabd2f>Println</span>(r.Method, <span style=color:#b8bb26>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ <span style=color:#fe8019>:=</span> r.<span style=color:#fabd2f>Cookie</span>(<span style=color:#b8bb26>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#fe8019>if</span> cookie <span style=color:#fe8019>!=</span> <span style=color:#fe8019>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#928374;font-style:italic>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>			ctx <span style=color:#fe8019>:=</span> context.<span style=color:#fabd2f>WithValue</span>(r.<span style=color:#fabd2f>Context</span>(), <span style=color:#b8bb26>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.<span style=color:#fabd2f>ServeHTTP</span>(w, r.<span style=color:#fabd2f>WithContext</span>(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span>			next.<span style=color:#fabd2f>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>StatusPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#928374;font-style:italic>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>	<span style=color:#fe8019>if</span> username <span style=color:#fe8019>:=</span> r.<span style=color:#fabd2f>Context</span>().<span style=color:#fabd2f>Value</span>(<span style=color:#b8bb26>&#34;Username&#34;</span>); username <span style=color:#fe8019>!=</span> <span style=color:#fe8019>nil</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>Write</span>([]<span style=color:#fabd2f>byte</span>(<span style=color:#b8bb26>&#34;Hello &#34;</span> <span style=color:#fe8019>+</span> username.(<span style=color:#fabd2f>string</span>) <span style=color:#fe8019>+</span> <span style=color:#b8bb26>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#fe8019>else</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>WriteHeader</span>(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.<span style=color:#fabd2f>Write</span>([]<span style=color:#fabd2f>byte</span>(<span style=color:#b8bb26>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>LoginPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#fe8019>:=</span> time.<span style=color:#fabd2f>Now</span>().<span style=color:#fabd2f>Add</span>(<span style=color:#d3869b>365</span> <span style=color:#fe8019>*</span> <span style=color:#d3869b>24</span> <span style=color:#fe8019>*</span> time.Hour)  <span style=color:#928374;font-style:italic>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>	cookie <span style=color:#fe8019>:=</span> http.Cookie{Name: <span style=color:#b8bb26>&#34;username&#34;</span>, Value: <span style=color:#b8bb26>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#fabd2f>SetCookie</span>(w, <span style=color:#fe8019>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>LogoutPage</span>(w http.ResponseWriter, r <span style=color:#fe8019>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#fe8019>:=</span> time.<span style=color:#fabd2f>Now</span>().<span style=color:#fabd2f>AddDate</span>(<span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#fe8019>-</span><span style=color:#d3869b>1</span>)	<span style=color:#928374;font-style:italic>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>	cookie <span style=color:#fe8019>:=</span> http.Cookie{Name: <span style=color:#b8bb26>&#34;username&#34;</span>, Value: <span style=color:#b8bb26>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#fabd2f>SetCookie</span>(w, <span style=color:#fe8019>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe8019>func</span> <span style=color:#fabd2f>main</span>() {
</span></span><span style=display:flex><span>	mux <span style=color:#fe8019>:=</span> http.<span style=color:#fabd2f>NewServeMux</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.<span style=color:#fabd2f>HandleFunc</span>(<span style=color:#b8bb26>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#fabd2f>HandleFunc</span>(<span style=color:#b8bb26>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#fabd2f>HandleFunc</span>(<span style=color:#b8bb26>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.<span style=color:#fabd2f>Println</span>(<span style=color:#b8bb26>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	contextedMux <span style=color:#fe8019>:=</span> <span style=color:#fabd2f>AddContext</span>(mux)
</span></span><span style=display:flex><span>	log.<span style=color:#fabd2f>Fatal</span>(http.<span style=color:#fabd2f>ListenAndServe</span>(<span style=color:#b8bb26>&#34;:8085&#34;</span>, contextedMux))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div style=text-align:center;margin-bottom:30px;padding-top:20px><h5 style=font-weight:600;margin-bottom:10px;color:#b04161>「Buy me a coffee」</h5><div id=QR><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://glepnir.neovim.pro/images/wechat.png alt="WeChat Pay"></a><h5 style=font-weight:600;margin-top:5px></h5></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://glepnir.neovim.pro/images/alipay.png alt=Alipay></a><h5 style=font-weight:600;margin-top:5px></h5></div></div></div><script src=https://utteranc.es/client.js repo=glepnir/glepnir.github.io issue-term=title theme=dark-blue crossorigin=anonymous async></script><div class=footer>Copyright © 2022 author glepnir</div></div></body></html>