<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png }><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="The Best Theme Isn't the Prettiest—It's the One You Forget Exists"><title>The Best Theme Isn't the Prettiest—It's the One You Forget Exists | glepnir's blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.0e9c0bb0a7de7a330263937778a4d7c0d0c6be7f327c69a0223c9f2fd31e00d5.css media=all><link rel=stylesheet href=/css/katex.min.css integrity="sha512-0u6F0kGPTUgsoq8qPa0w03CxxmEz3qYfl9eTPJL8DK4QJE9/XL1SSoiXoYhvDXCrBMBVWtaAIWsWoCg1TkJybA==" crossorigin=anonymous></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/><u>H</u>ome</a></li><li><a tabindex=-1 class=menu-link href=/tags><u>T</u>ags</a></li></ul></nav><div id=single-header><h1>The Best Theme Isn&rsquo;t the Prettiest—It&rsquo;s the One You Forget Exists</h1><div id=single-meta><span class=datesub>Dec 24, 2025</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://www.functor.me/tags/neovim/>#neovim</a>
</span>&nbsp; <span><a href=https://www.functor.me/tags/color-science/>#color-science</a>
</span>&nbsp; <span><a href=https://www.functor.me/tags/vision-research/>#vision-research</a>
</span>&nbsp; <span><a href=https://www.functor.me/tags/oklab/>#oklab</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#the-insight-color-science-exists-for-a-reason>The Insight: Color Science Exists for a Reason</a></li><li><a href=#foundation-1-perceptual-color-spaces>Foundation 1: Perceptual Color Spaces</a><ul><li><a href=#the-problem-with-rgb-and-hsl>The Problem with RGB and HSL</a></li><li><a href=#enter-oklab>Enter Oklab</a></li><li><a href=#implementation-in-lua>Implementation in Lua</a></li></ul></li><li><a href=#foundation-2-what-to-highlight---empirical-research>Foundation 2: What to Highlight - Empirical Research</a><ul><li><a href=#hannebauer-et-al-2018-the-surprising-truth-about-syntax-highlighting>Hannebauer et al. (2018): The Surprising Truth About Syntax Highlighting</a></li><li><a href=#tonsky-2025-the-neutral-variables-principle>Tonsky (2025): The Neutral Variables Principle</a></li><li><a href=#from-research-to-design-decisions>From Research to Design Decisions</a></li></ul></li><li><a href=#foundation-3-contrast-sensitivity-function-csf>Foundation 3: Contrast Sensitivity Function (CSF)</a><ul><li><a href=#key-insight-luminance-hierarchy-matters-more-than-hue>Key Insight: Luminance Hierarchy Matters More Than Hue</a></li><li><a href=#deriving-the-three-layer-luminance-hierarchy>Deriving the Three-Layer Luminance Hierarchy</a></li><li><a href=#summary-the-csf-optimized-luminance-hierarchy>Summary: The CSF-Optimized Luminance Hierarchy</a></li></ul></li><li><a href=#foundation-4-ciecam02-color-appearance-model>Foundation 4: CIECAM02 Color Appearance Model</a><ul><li><a href=#hue-discrimination>Hue Discrimination</a></li></ul></li><li><a href=#foundation-5-color-fatigue-research>Foundation 5: Color Fatigue Research</a><ul><li><a href=#saturation-calculation>Saturation Calculation</a></li></ul></li><li><a href=#foundation-6-color-semantics>Foundation 6: Color Semantics</a><ul><li><a href=#deriving-the-ast-token--color-mapping>Deriving the AST Token → Color Mapping</a></li></ul></li><li><a href=#complete-implementation>Complete Implementation</a></li><li><a href=#results>Results</a></li><li><a href=#individual-differences-a-note-of-caution>Individual Differences: A Note of Caution</a><ul><li><a href=#how-to-adapt-this-for-yourself>How to Adapt This for Yourself</a></li></ul></li><li><a href=#summary-and-takeaways>Summary and Takeaways</a></li><li><a href=#references>References</a></li></ul></nav></aside><main><p>Over the past few years, I&rsquo;ve created numerous Neovim color schemes. My workflow was always the same: pick an existing theme, adjust its colors in HSL space until they felt comfortable, and use it for a while. But invariably, after several weeks or months, the same pattern emerged—visual fatigue. My eyes would tire faster during long coding sessions, colors that once felt &ldquo;right&rdquo; started to irritate, and I&rsquo;d find myself tweaking values again and again.</p><p>The cycle was frustrating: find theme → adjust → use → fatigue → repeat. Each iteration felt arbitrary. I was working blind, relying purely on subjective perception without understanding <em>why</em> certain colors caused fatigue and others didn&rsquo;t.</p><p>This is the story of how I broke that cycle by building a color scheme from scientific first principles.</p><h2 id=the-insight-color-science-exists-for-a-reason>The Insight: Color Science Exists for a Reason</h2><p>The breakthrough came when I realized: vision scientists have spent decades studying exactly these problems. Research exists on:</p><ul><li>How the human eye perceives contrast (Contrast Sensitivity Function)</li><li>Which color spaces are perceptually uniform (Oklab, CIELAB)</li><li>What causes color-induced visual fatigue (chromatic pupillometry studies)</li><li>How colors map to semantic meaning across cultures (color semantics research)</li><li>What syntax elements should be highlighted (empirical programming research)</li></ul><p>Instead of adjusting colors arbitrarily in HSL space, I could <em>derive</em> them from scientific principles.</p><h2 id=foundation-1-perceptual-color-spaces>Foundation 1: Perceptual Color Spaces</h2><h3 id=the-problem-with-rgb-and-hsl>The Problem with RGB and HSL</h3><p>RGB and HSL are convenient for computers but terrible for human perception. In RGB, the distance between <code>#FF0000</code> (red) and <code>#FF0011</code> (slightly different red) has no relationship to how <em>different</em> they appear to our eyes. HSL is better but still suffers from perceptual non-uniformity.</p><h3 id=enter-oklab>Enter Oklab</h3><p>Oklab [1] is a perceptually uniform color space designed by Björn Ottosson. In Oklab:</p><ul><li>Euclidean distance corresponds to perceived color difference</li><li>Lightness (L) separates from chroma</li><li>Hue manipulation is more intuitive</li></ul><p>The transformation from Oklab to RGB involves four steps:</p><p><strong>Step 1: Oklab → LMS (cone response)</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>l</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>m</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>s</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.3963</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.2158</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.1056</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.0639</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.0895</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1.2915</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>L</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>a</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>b</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\begin{bmatrix} l \\ m \\ s \end{bmatrix} = \begin{bmatrix} 1 &amp; 0.3963 &amp; 0.2158 \\ 1 &amp; -0.1056 &amp; -0.0639 \\ 1 &amp; -0.0895 &amp; -1.2915 \end{bmatrix} \begin{bmatrix} L \\ a \\ b \end{bmatrix}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.6em;vertical-align:-1.55em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M403 1759V84H666V0H319V1759v0 1759h347v-84H403zm0 0V0H319V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">m</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">s</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M347 1759V0H0V84H263V1759v0 1759H0v84H347zm0 0V0H263V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:3.6em;vertical-align:-1.55em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M403 1759V84H666V0H319V1759v0 1759h347v-84H403zm0 0V0H319V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.3963</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>0.1056</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>0.0895</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.2158</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>0.0639</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>1.2915</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M347 1759V0H0V84H263V1759v0 1759H0v84H347zm0 0V0H263V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M403 1759V84H666V0H319V1759v0 1759h347v-84H403zm0 0V0H319V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">L</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">a</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">b</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M347 1759V0H0V84H263V1759v0 1759H0v84H347zm0 0V0H263V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span></span></span></span></span><p><strong>Step 2: Inverse cube root</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>LMS</mtext><mtext>linear</mtext></msub><mo>=</mo><mo stretchy="false">[</mo><msup><mi>l</mi><mn>3</mn></msup><mo separator="true">,</mo><msup><mi>m</mi><mn>3</mn></msup><mo separator="true">,</mo><msup><mi>s</mi><mn>3</mn></msup><msup><mo stretchy="false">]</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">
\text{LMS}_{\text{linear}} = [l^3, m^3, s^3]^T
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord text"><span class=mord>LMS</span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">linear</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.1413em;vertical-align:-.25em></span><span class=mopen>[</span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8641em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">m</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8641em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">s</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8641em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class=mclose><span class=mclose>]</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.13889em>T</span></span></span></span></span></span></span></span></span></span></span></span><p><strong>Step 3: LMS → Linear RGB</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>R</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>G</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>B</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4.0767</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>3.3077</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.2310</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1.2684</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.6098</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.3413</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.0042</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.7034</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.7076</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>l</mi><mn>3</mn></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>m</mi><mn>3</mn></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>s</mi><mn>3</mn></msup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\begin{bmatrix} R \\ G \\ B \end{bmatrix} = \begin{bmatrix} 4.0767 &amp; -3.3077 &amp; 0.2310 \\ -1.2684 &amp; 2.6098 &amp; -0.3413 \\ -0.0042 &amp; -0.7034 &amp; 1.7076 \end{bmatrix} \begin{bmatrix} l^3 \\ m^3 \\ s^3 \end{bmatrix}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.6em;vertical-align:-1.55em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M403 1759V84H666V0H319V1759v0 1759h347v-84H403zm0 0V0H319V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.00773em>R</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">G</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.05017em>B</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M347 1759V0H0V84H263V1759v0 1759H0v84H347zm0 0V0H263V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:3.6em;vertical-align:-1.55em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M403 1759V84H666V0H319V1759v0 1759h347v-84H403zm0 0V0H319V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>4.0767</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>1.2684</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>0.0042</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>3.3077</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>2.6098</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>0.7034</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.2310</span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>−</span><span class=mord>0.3413</span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>1.7076</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M347 1759V0H0V84H263V1759v0 1759H0v84H347zm0 0V0H263V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M403 1759V84H666V0H319V1759v0 1759h347v-84H403zm0 0V0H319V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.21em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8141em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">m</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8141em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span><span style=top:-1.81em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">s</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8141em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.05em><span style=top:-4.05em><span class=pstrut style=height:5.6em></span><span style=width:.667em;height:3.6em><svg width=".667em" height="3.6em" viewBox="0 0 667 3600"><path d="M347 1759V0H0V84H263V1759v0 1759H0v84H347zm0 0V0H263V1759v0 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.55em><span></span></span></span></span></span></span></span></span></span></span></span><p><strong>Step 4: Gamma correction (sRGB)</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>C</mi><mtext>sRGB</mtext></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>12.92</mn><mo>×</mo><msub><mi>C</mi><mtext>linear</mtext></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if </mtext><msub><mi>C</mi><mtext>linear</mtext></msub><mo>≤</mo><mn>0.0031308</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1.055</mn><mo>×</mo><msubsup><mi>C</mi><mtext>linear</mtext><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>2.4</mn></mrow></msubsup><mo>−</mo><mn>0.055</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
C_{\text{sRGB}} = \begin{cases} 12.92 \times C_{\text{linear}} &amp; \text{if } C_{\text{linear}} \leq 0.0031308 \\ 1.055 \times C_{\text{linear}}^{1/2.4} - 0.055 &amp; \text{otherwise} \end{cases}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:-.0715em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">sRGB</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:3em;vertical-align:-1.25em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size4">{</span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7084em><span style=top:-3.7452em><span class=pstrut style=height:3.0448em></span><span class=mord><span class=mord>12.92</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0715em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">linear</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.2684em><span class=pstrut style=height:3.0448em></span><span class=mord><span class=mord>1.055</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.0448em><span style=top:-2.3987em;margin-left:-.0715em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">linear</span></span></span></span></span><span style=top:-3.2198em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1/2.4</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3013em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.055</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2084em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7084em><span style=top:-3.7452em><span class=pstrut style=height:3.0448em></span><span class=mord><span class="mord text"><span class=mord>if </span></span><span class=mord><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0715em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">linear</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≤</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.0031308</span></span></span><span style=top:-2.2684em><span class=pstrut style=height:3.0448em></span><span class=mord><span class="mord text"><span class=mord>otherwise</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2084em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=implementation-in-lua>Implementation in Lua</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=kr>function</span> <span class=nf>oklab_to_linear_rgb</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>-- Step 1: Oklab to LMS</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>l</span> <span class=o>=</span> <span class=n>L</span> <span class=o>+</span> <span class=mf>0.3963377774</span> <span class=o>*</span> <span class=n>a</span> <span class=o>+</span> <span class=mf>0.2158037573</span> <span class=o>*</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>m</span> <span class=o>=</span> <span class=n>L</span> <span class=o>-</span> <span class=mf>0.1055613458</span> <span class=o>*</span> <span class=n>a</span> <span class=o>-</span> <span class=mf>0.0638541728</span> <span class=o>*</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>s</span> <span class=o>=</span> <span class=n>L</span> <span class=o>-</span> <span class=mf>0.0894841775</span> <span class=o>*</span> <span class=n>a</span> <span class=o>-</span> <span class=mf>1.2914855480</span> <span class=o>*</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>-- Step 2: Inverse cube root</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>l3</span><span class=p>,</span> <span class=n>m3</span><span class=p>,</span> <span class=n>s3</span> <span class=o>=</span> <span class=n>l</span> <span class=o>*</span> <span class=n>l</span> <span class=o>*</span> <span class=n>l</span><span class=p>,</span> <span class=n>m</span> <span class=o>*</span> <span class=n>m</span> <span class=o>*</span> <span class=n>m</span><span class=p>,</span> <span class=n>s</span> <span class=o>*</span> <span class=n>s</span> <span class=o>*</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>-- Step 3: LMS to linear RGB</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>r</span> <span class=o>=</span> <span class=mf>4.0767416621</span> <span class=o>*</span> <span class=n>l3</span> <span class=o>-</span> <span class=mf>3.3077115913</span> <span class=o>*</span> <span class=n>m3</span> <span class=o>+</span> <span class=mf>0.2309699292</span> <span class=o>*</span> <span class=n>s3</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>g</span> <span class=o>=</span> <span class=o>-</span><span class=mf>1.2684380046</span> <span class=o>*</span> <span class=n>l3</span> <span class=o>+</span> <span class=mf>2.6097574011</span> <span class=o>*</span> <span class=n>m3</span> <span class=o>-</span> <span class=mf>0.3413193965</span> <span class=o>*</span> <span class=n>s3</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>b_out</span> <span class=o>=</span> <span class=o>-</span><span class=mf>0.0041960863</span> <span class=o>*</span> <span class=n>l3</span> <span class=o>-</span> <span class=mf>0.7034186147</span> <span class=o>*</span> <span class=n>m3</span> <span class=o>+</span> <span class=mf>1.7076147010</span> <span class=o>*</span> <span class=n>s3</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>return</span> <span class=n>r</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>b_out</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=kr>function</span> <span class=nf>linear_to_srgb_component</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>-- Step 4: Gamma correction</span>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=n>c</span> <span class=o>&lt;=</span> <span class=mf>0.0031308</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>c</span> <span class=o>*</span> <span class=mf>12.92</span>
</span></span><span class=line><span class=cl>  <span class=kr>else</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=mf>1.055</span> <span class=o>*</span> <span class=p>(</span><span class=n>c</span> <span class=o>^</span> <span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=mf>2.4</span><span class=p>))</span> <span class=o>-</span> <span class=mf>0.055</span>
</span></span><span class=line><span class=cl>  <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=kr>function</span> <span class=nf>oklab_to_srgb</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>local</span> <span class=n>r</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>b_comp</span> <span class=o>=</span> <span class=n>oklab_to_linear_rgb</span><span class=p>(</span><span class=n>L</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>r</span> <span class=o>=</span> <span class=n>linear_to_srgb_component</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>g</span> <span class=o>=</span> <span class=n>linear_to_srgb_component</span><span class=p>(</span><span class=n>g</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>b_comp</span> <span class=o>=</span> <span class=n>linear_to_srgb_component</span><span class=p>(</span><span class=n>b_comp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>-- Clamp and convert to 8-bit</span>
</span></span><span class=line><span class=cl>  <span class=n>r</span> <span class=o>=</span> <span class=n>math.floor</span><span class=p>(</span><span class=n>math.max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>math.min</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>))</span> <span class=o>*</span> <span class=mi>255</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>g</span> <span class=o>=</span> <span class=n>math.floor</span><span class=p>(</span><span class=n>math.max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>math.min</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>g</span><span class=p>))</span> <span class=o>*</span> <span class=mi>255</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>b_comp</span> <span class=o>=</span> <span class=n>math.floor</span><span class=p>(</span><span class=n>math.max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>math.min</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>b_comp</span><span class=p>))</span> <span class=o>*</span> <span class=mi>255</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>return</span> <span class=n>string.format</span><span class=p>(</span><span class=s1>&#39;#%02x%02x%02x&#39;</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>b_comp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><p>Now I can specify colors as perceptual properties rather than hex codes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- Instead of: local orange = &#34;#c5895b&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>-- I write:</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>orange</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.055</span><span class=p>,</span> <span class=mf>0.065</span><span class=p>)</span>
</span></span></code></pre></div><p>The formula <em>is</em> the color. No more arbitrary hex values.</p><h2 id=foundation-2-what-to-highlight---empirical-research>Foundation 2: What to Highlight - Empirical Research</h2><p>Before deciding <em>how</em> to color code elements, I needed to understand <em>which</em> elements should be highlighted at all.</p><h3 id=hannebauer-et-al-2018-the-surprising-truth-about-syntax-highlighting>Hannebauer et al. (2018): The Surprising Truth About Syntax Highlighting</h3><p>A study with 390 programming novices [7] found something surprising:</p><blockquote><p>&ldquo;Syntax highlighting has no significant effect on code comprehension or correctness&rdquo;</p></blockquote><p>But the study revealed a crucial insight: highlighting <em>does</em> help when it emphasizes <strong>structural elements</strong> rather than coloring everything equally. The key principle:</p><p><strong>Highlight structure, minimize noise.</strong></p><h3 id=tonsky-2025-the-neutral-variables-principle>Tonsky (2025): The Neutral Variables Principle</h3><p>Ivan Tonsky&rsquo;s analysis revealed why most themes feel noisy:</p><blockquote><p>&ldquo;Your code is mostly references to variables and method invocation. If we highlight those, we&rsquo;ll have to highlight more than 75% of your code.&rdquo;</p></blockquote><p>His recommendation: Keep variables and operators <strong>neutral</strong> (same color as regular text). Only highlight structural elements.</p><h3 id=from-research-to-design-decisions>From Research to Design Decisions</h3><p>These findings led to my core highlighting strategy:</p><ol><li><p><strong>Highlight (bright colors):</strong></p><ul><li>Control flow keywords (if, for, while, return)</li><li>Function definitions</li><li>Type declarations</li></ul></li><li><p><strong>Keep neutral (regular text color):</strong></p><ul><li>Variable names</li><li>Operators</li><li>Function parameters</li></ul></li><li><p><strong>Dim (lower luminance):</strong></p><ul><li>Comments</li><li>Delimiters</li></ul></li></ol><p>This creates a visual hierarchy where code structure &ldquo;pops&rdquo; while the majority of text remains calm.</p><h2 id=foundation-3-contrast-sensitivity-function-csf>Foundation 3: Contrast Sensitivity Function (CSF)</h2><p>The human visual system doesn&rsquo;t respond uniformly to all contrasts. Barten&rsquo;s CSF model [2] reveals that we are 5-10× more sensitive to <em>luminance</em> contrast than <em>chromatic</em> contrast.</p><h3 id=key-insight-luminance-hierarchy-matters-more-than-hue>Key Insight: Luminance Hierarchy Matters More Than Hue</h3><p>This was the game-changer. Instead of asking &ldquo;should keywords be orange or yellow?&rdquo;, I should ask &ldquo;should keywords be <em>brighter</em> than data?&rdquo;</p><h3 id=deriving-the-three-layer-luminance-hierarchy>Deriving the Three-Layer Luminance Hierarchy</h3><p>I needed to design a luminance hierarchy that satisfies:</p><ol><li><strong>CSF comfort threshold:</strong> <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>L</mi><mo>≥</mo><mn>0.02</mn></mrow><annotation encoding="application/x-tex">\Delta L \geq 0.02</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8193em;vertical-align:-.136em></span><span class=mord>Δ</span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≥</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.02</span></span></span></span> for comfortable discrimination</li><li><strong>WCAG accessibility:</strong> Adequate contrast ratios with background</li><li><strong>Perceptual distinctness:</strong> Each layer feels clearly different</li></ol><p><strong>Starting constraints:</strong></p><p>Background: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>bg</mtext></msub><mo>=</mo><mn>0.24</mn></mrow><annotation encoding="application/x-tex">L_{\text{bg}} = 0.24</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.24</span></span></span></span> (dark theme, reduces eye strain)
Foreground: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>fg</mtext></msub><mo>=</mo><mn>0.74</mn></mrow><annotation encoding="application/x-tex">L_{\text{fg}} = 0.74</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.74</span></span></span></span> (7.0:1 contrast, WCAG AAA)</p><p><strong>Layer assignment based on Hannebauer (2018):</strong></p><ul><li><strong>Layer 1 (highest):</strong> Structure (keywords, functions, types) - most important for comprehension</li><li><strong>Layer 2 (middle):</strong> Errors - need prominence without overwhelming</li><li><strong>Layer 3 (lowest):</strong> Data (strings, numbers) - secondary importance</li></ul><p><strong>Calculating optimal luminance values:</strong></p><p>The total usable luminance range is: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>fg</mtext></msub><mo>−</mo><msub><mi>L</mi><mtext>bg</mtext></msub><mo>=</mo><mn>0.74</mn><mo>−</mo><mn>0.24</mn><mo>=</mo><mn>0.50</mn></mrow><annotation encoding="application/x-tex">L_{\text{fg}} - L_{\text{bg}} = 0.74 - 0.24 = 0.50</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.74</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.24</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.50</span></span></span></span></p><p>For syntax colors, I reserved the upper portion of this range to maintain sufficient contrast with background. Working backwards from foreground:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>L</mi><mtext>reserve</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.06</mn><mtext> (headroom from foreground)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>L</mi><mtext>max_syntax</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.74</mn><mo>−</mo><mn>0.06</mn><mo>=</mo><mn>0.68</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
L_{\text{reserve}} &amp;= 0.06 \text{ (headroom from foreground)} \\
L_{\text{max\_syntax}} &amp;= 0.74 - 0.06 = 0.68
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.007em;vertical-align:-1.2535em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7535em><span style=top:-3.9135em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">reserve</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.4135em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.2806em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max_syntax</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.367em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2535em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7535em><span style=top:-3.9135em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.06</span><span class="mord text"><span class=mord> (headroom from foreground)</span></span></span></span><span style=top:-2.4135em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.74</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.06</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.68</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2535em><span></span></span></span></span></span></span></span></span></span></span></span><p>Now applying the CSF minimum threshold <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>L</mi><mo>=</mo><mn>0.02</mn></mrow><annotation encoding="application/x-tex">\Delta L = 0.02</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class=mord>Δ</span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.02</span></span></span></span>:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>Layer 1 (Structure):</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="1em"/><msub><mi>L</mi><mn>1</mn></msub><mo>=</mo><mn>0.68</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>Layer 2 (Diagnostics):</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="1em"/><msub><mi>L</mi><mn>2</mn></msub><mo>=</mo><msub><mi>L</mi><mn>1</mn></msub><mo>−</mo><mn>0.02</mn><mo>=</mo><mn>0.66</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mtext>Layer 3 (Data):</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="1em"/><msub><mi>L</mi><mn>3</mn></msub><mo>=</mo><msub><mi>L</mi><mn>2</mn></msub><mo>−</mo><mn>0.02</mn><mo>=</mo><mn>0.64</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\text{Layer 1 (Structure):} &amp;\quad L_1 = 0.68 \\
\text{Layer 2 (Diagnostics):} &amp;\quad L_2 = L_1 - 0.02 = 0.66 \\
\text{Layer 3 (Data):} &amp;\quad L_3 = L_2 - 0.02 = 0.64
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:4.5em;vertical-align:-2em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.5em><span style=top:-4.66em><span class=pstrut style=height:3em></span><span class=mord><span class="mord text"><span class=mord>Layer 1 (Structure):</span></span></span></span><span style=top:-3.16em><span class=pstrut style=height:3em></span><span class=mord><span class="mord text"><span class=mord>Layer 2 (Diagnostics):</span></span></span></span><span style=top:-1.66em><span class=pstrut style=height:3em></span><span class=mord><span class="mord text"><span class=mord>Layer 3 (Data):</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.5em><span style=top:-4.66em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:1em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.68</span></span></span><span style=top:-3.16em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:1em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.02</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.66</span></span></span><span style=top:-1.66em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:1em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.02</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.64</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2em><span></span></span></span></span></span></span></span></span></span></span></span><p><strong>Verification against WCAG:</strong></p><p>Using the contrast ratio formula <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>CR</mtext><mo>=</mo><mfrac><mrow><msub><mi>L</mi><mn>1</mn></msub><mo>+</mo><mn>0.05</mn></mrow><mrow><msub><mi>L</mi><mn>2</mn></msub><mo>+</mo><mn>0.05</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{CR} = \frac{L_1 + 0.05}{L_2 + 0.05}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord text"><span class=mord>CR</span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.3335em;vertical-align:-.4451em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8884em><span style=top:-2.655em><span class=pstrut style=height:3em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3173em><span style=top:-2.357em;margin-left:0;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.143em><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">0.05</span></span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.4101em><span class=pstrut style=height:3em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3173em><span style=top:-2.357em;margin-left:0;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.143em><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">0.05</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.4451em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>CR</mtext><mo stretchy="false">(</mo><msub><mi>L</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>L</mi><mtext>bg</mtext></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mn>0.68</mn><mo>+</mo><mn>0.05</mn></mrow><mrow><mn>0.24</mn><mo>+</mo><mn>0.05</mn></mrow></mfrac><mo>=</mo><mn>5.52</mn><mo>:</mo><mn>1</mn><mspace width="1em"/><mtext>(AA)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>CR</mtext><mo stretchy="false">(</mo><msub><mi>L</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>L</mi><mtext>bg</mtext></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mn>0.66</mn><mo>+</mo><mn>0.05</mn></mrow><mrow><mn>0.24</mn><mo>+</mo><mn>0.05</mn></mrow></mfrac><mo>=</mo><mn>5.03</mn><mo>:</mo><mn>1</mn><mspace width="1em"/><mtext>(AA)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>CR</mtext><mo stretchy="false">(</mo><msub><mi>L</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>L</mi><mtext>bg</mtext></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mn>0.64</mn><mo>+</mo><mn>0.05</mn></mrow><mrow><mn>0.24</mn><mo>+</mo><mn>0.05</mn></mrow></mfrac><mo>=</mo><mn>4.76</mn><mo>:</mo><mn>1</mn><mspace width="1em"/><mtext>(AA)</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\text{CR}(L_1, L_{\text{bg}}) &amp;= \frac{0.68 + 0.05}{0.24 + 0.05} = 5.52:1 \quad \text{(AA)} \\
\text{CR}(L_2, L_{\text{bg}}) &amp;= \frac{0.66 + 0.05}{0.24 + 0.05} = 5.03:1 \quad \text{(AA)} \\
\text{CR}(L_3, L_{\text{bg}}) &amp;= \frac{0.64 + 0.05}{0.24 + 0.05} = 4.76:1 \quad \text{(AA)}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:7.1723em;vertical-align:-3.3362em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:3.8362em><span style=top:-5.8362em><span class=pstrut style=height:3.3214em></span><span class=mord><span class="mord text"><span class=mord>CR</span></span><span class=mopen>(</span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span><span style=top:-3.4454em><span class=pstrut style=height:3.3214em></span><span class=mord><span class="mord text"><span class=mord>CR</span></span><span class=mopen>(</span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span><span style=top:-1.0546em><span class=pstrut style=height:3.3214em></span><span class=mord><span class="mord text"><span class=mord>CR</span></span><span class=mopen>(</span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:3.3362em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:3.8362em><span style=top:-5.8362em><span class=pstrut style=height:3.3214em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3214em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.24</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.05</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.68</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.05</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.7693em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>5.52</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span><span class=mspace style=margin-right:.2778em></span><span class=mord>1</span><span class=mspace style=margin-right:1em></span><span class="mord text"><span class=mord>(AA)</span></span></span></span><span style=top:-3.4454em><span class=pstrut style=height:3.3214em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3214em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.24</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.05</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.66</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.05</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.7693em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>5.03</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span><span class=mspace style=margin-right:.2778em></span><span class=mord>1</span><span class=mspace style=margin-right:1em></span><span class="mord text"><span class=mord>(AA)</span></span></span></span><span style=top:-1.0546em><span class=pstrut style=height:3.3214em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3214em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.24</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.05</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>0.64</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord>0.05</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.7693em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>4.76</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span><span class=mspace style=margin-right:.2778em></span><span class=mord>1</span><span class=mspace style=margin-right:1em></span><span class="mord text"><span class=mord>(AA)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:3.3362em><span></span></span></span></span></span></span></span></span></span></span></span><p>All three layers meet WCAG AA standards while maintaining <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>L</mi><mo>=</mo><mn>0.02</mn></mrow><annotation encoding="application/x-tex">\Delta L = 0.02</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class=mord>Δ</span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.02</span></span></span></span> separation.</p><p><strong>Why this matters:</strong> In my old themes, I had errors (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.64</mn></mrow><annotation encoding="application/x-tex">L=0.64</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.64</span></span></span></span>) at the same brightness as strings. Errors weren&rsquo;t visually salient! Now errors are a distinct layer (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.66</mn></mrow><annotation encoding="application/x-tex">L=0.66</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.66</span></span></span></span>), immediately noticeable but not overwhelming.</p><p><strong>Perceptual validation:</strong></p><p>The 3-layer system creates three distinct &ldquo;brightness tiers&rdquo;:</p><ul><li><strong>Tier 1 (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.68</mn></mrow><annotation encoding="application/x-tex">L=0.68</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.68</span></span></span></span>):</strong> Code structure stands out, guides the eye</li><li><strong>Tier 2 (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.66</mn></mrow><annotation encoding="application/x-tex">L=0.66</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.66</span></span></span></span>):</strong> Errors pop without dominating</li><li><strong>Tier 3 (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.64</mn></mrow><annotation encoding="application/x-tex">L=0.64</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.64</span></span></span></span>):</strong> Data recedes appropriately</li></ul><p>This matches the importance hierarchy from Hannebauer&rsquo;s research: structure > errors > data.</p><h3 id=summary-the-csf-optimized-luminance-hierarchy>Summary: The CSF-Optimized Luminance Hierarchy</h3><table><thead><tr><th>Layer</th><th>Luminance</th><th>Elements</th><th>Rationale</th></tr></thead><tbody><tr><td>1</td><td><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.68</mn></mrow><annotation encoding="application/x-tex">L=0.68</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.68</span></span></span></span></td><td>Keywords, Functions, Types</td><td>Highest importance for comprehension</td></tr><tr><td>2</td><td><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.66</mn></mrow><annotation encoding="application/x-tex">L=0.66</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.66</span></span></span></span></td><td>Errors, Diagnostics</td><td>Need prominence, not dominance</td></tr><tr><td>3</td><td><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.64</mn></mrow><annotation encoding="application/x-tex">L=0.64</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.64</span></span></span></span></td><td>Strings, Numbers, Constants</td><td>Secondary to structure</td></tr><tr><td>-</td><td><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.24</mn></mrow><annotation encoding="application/x-tex">L=0.24</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.24</span></span></span></span></td><td>Background</td><td>Low strain for long sessions</td></tr><tr><td>-</td><td><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.74</mn></mrow><annotation encoding="application/x-tex">L=0.74</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.74</span></span></span></span></td><td>Foreground text</td><td>7.0:1 contrast (AAA)</td></tr></tbody></table><p>Key properties:</p><ul><li><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>L</mi><mo>=</mo><mn>0.02</mn></mrow><annotation encoding="application/x-tex">\Delta L = 0.02</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class=mord>Δ</span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.02</span></span></span></span> between layers (CSF comfortable threshold)</li><li>All layers meet WCAG AA (contrast <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo><mn>4.5</mn><mo>:</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\geq 4.5:1</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7719em;vertical-align:-.136em></span><span class=mrel>≥</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>4.5</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>1</span></span></span></span>)</li><li>Total range: 0.64-0.68 (focused, not excessive)</li></ul><h2 id=foundation-4-ciecam02-color-appearance-model>Foundation 4: CIECAM02 Color Appearance Model</h2><p>CIECAM02 [3] helps us understand how colors appear under different viewing conditions. The simplified chroma calculation is:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mo>≈</mo><mn>100</mn><mo>×</mo><mi>s</mi><mo>×</mo><msqrt><mi>J</mi></msqrt></mrow><annotation encoding="application/x-tex">
C \approx 100 \times s \times \sqrt{J}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>100</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6667em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1.04em;vertical-align:-.0645em></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.9755em><span class=svg-align style=top:-3em><span class=pstrut style=height:3em></span><span class=mord style=padding-left:.833em><span class="mord mathnormal" style=margin-right:.09618em>J</span></span></span><span style=top:-2.9355em><span class=pstrut style=height:3em></span><span class=hide-tail style=min-width:.853em;height:1.08em><svg width="400em" height="1.08em" viewBox="0 0 4e5 1080" preserveAspectRatio="xMinYMin slice"><path d="M95 702c-2.7.0-7.17-2.7-13.5-8-5.8-5.3-9.5-10-9.5-14 0-2 .3-3.3 1-4 1.3-2.7 23.83-20.7 67.5-54 44.2-33.3 65.8-50.3 66.5-51 1.3-1.3 3-2 5-2 4.7.0 8.7 3.3 12 10s173 378 173 378c.7.0 35.3-71 104-213s137.5-285 206.5-429S812 97.3 814 94c5.3-9.3 12-14 20-14H4e5v40H845.2724s-225.272 467-225.272 467-235 486-235 486c-2.7 4.7-9 7-19 7-6 0-10-1-12-3s-194-422-194-422-65 47-65 47zM834 80h4e5v40H834z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.0645em><span></span></span></span></span></span></span></span></span></span><p>where <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">s</span></span></span></span> is saturation and <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.09618em>J</span></span></span></span> is lightness (0-100 scale).</p><p>For comfortable long-term viewing, chroma should be in the range [30, 100]. This constrains our saturation:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo>=</mo><mfrac><mi>C</mi><mrow><mn>100</mn><mo>×</mo><msqrt><mi>J</mi></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">
s = \frac{C}{100 \times \sqrt{J}}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.2903em;vertical-align:-.93em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3603em><span style=top:-2.1833em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>100</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.9267em><span class=svg-align style=top:-3em><span class=pstrut style=height:3em></span><span class=mord style=padding-left:.833em><span class="mord mathnormal" style=margin-right:.09618em>J</span></span></span><span style=top:-2.8867em><span class=pstrut style=height:3em></span><span class=hide-tail style=min-width:.853em;height:1.08em><svg width="400em" height="1.08em" viewBox="0 0 4e5 1080" preserveAspectRatio="xMinYMin slice"><path d="M95 702c-2.7.0-7.17-2.7-13.5-8-5.8-5.3-9.5-10-9.5-14 0-2 .3-3.3 1-4 1.3-2.7 23.83-20.7 67.5-54 44.2-33.3 65.8-50.3 66.5-51 1.3-1.3 3-2 5-2 4.7.0 8.7 3.3 12 10s173 378 173 378c.7.0 35.3-71 104-213s137.5-285 206.5-429S812 97.3 814 94c5.3-9.3 12-14 20-14H4e5v40H845.2724s-225.272 467-225.272 467-235 486-235 486c-2.7 4.7-9 7-19 7-6 0-10-1-12-3s-194-422-194-422-65 47-65 47zM834 80h4e5v40H834z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1133em><span></span></span></span></span></span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07153em>C</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.93em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><p>For <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>≈</mo><mn>0.65</mn></mrow><annotation encoding="application/x-tex">L \approx 0.65</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.65</span></span></span></span> (corresponding to <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>≈</mo><mn>65</mn></mrow><annotation encoding="application/x-tex">J \approx 65</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.09618em>J</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>65</span></span></span></span>):</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>s</mi><mtext>recommended</mtext></msub><mo>=</mo><mfrac><mn>65</mn><mrow><mn>100</mn><mo>×</mo><msqrt><mn>65</mn></msqrt></mrow></mfrac><mo>≈</mo><mn>0.081</mn></mrow><annotation encoding="application/x-tex">
s_{\text{recommended}} = \frac{65}{100 \times \sqrt{65}} \approx 0.081
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5806em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal">s</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">recommended</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.2514em;vertical-align:-.93em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3214em><span style=top:-2.2028em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>100</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.9072em><span class=svg-align style=top:-3em><span class=pstrut style=height:3em></span><span class=mord style=padding-left:.833em><span class=mord>65</span></span></span><span style=top:-2.8672em><span class=pstrut style=height:3em></span><span class=hide-tail style=min-width:.853em;height:1.08em><svg width="400em" height="1.08em" viewBox="0 0 4e5 1080" preserveAspectRatio="xMinYMin slice"><path d="M95 702c-2.7.0-7.17-2.7-13.5-8-5.8-5.3-9.5-10-9.5-14 0-2 .3-3.3 1-4 1.3-2.7 23.83-20.7 67.5-54 44.2-33.3 65.8-50.3 66.5-51 1.3-1.3 3-2 5-2 4.7.0 8.7 3.3 12 10s173 378 173 378c.7.0 35.3-71 104-213s137.5-285 206.5-429S812 97.3 814 94c5.3-9.3 12-14 20-14H4e5v40H845.2724s-225.272 467-225.272 467-235 486-235 486c-2.7 4.7-9 7-19 7-6 0-10-1-12-3s-194-422-194-422-65 47-65 47zM834 80h4e5v40H834z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1328em><span></span></span></span></span></span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>65</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.93em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.081</span></span></span></span></span><p>This gives us the target saturation range: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0.06</mn><mo separator="true">,</mo><mn>0.12</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s \in [0.06, 0.12]</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>[</span><span class=mord>0.06</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord>0.12</span><span class=mclose>]</span></span></span></span>.</p><h3 id=hue-discrimination>Hue Discrimination</h3><p>CIECAM02 also tells us that for low-saturation colors, we need a minimum hue separation:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>h</mi><mo>≥</mo><mn>20</mn><mi mathvariant="normal">°</mi><mtext> to </mtext><mn>25</mn><mi mathvariant="normal">°</mi></mrow><annotation encoding="application/x-tex">
\Delta h \geq 20° \text{ to } 25°
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8304em;vertical-align:-.136em></span><span class=mord>Δ</span><span class="mord mathnormal">h</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≥</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class=mord>20°</span><span class="mord text"><span class=mord> to </span></span><span class=mord>25°</span></span></span></span></span><p>I verified all adjacent hues meet this:</p><pre tabindex=0><code>Red (27°) → Orange (50°): Δh = 23° ✓
Orange (50°) → Yellow (76°): Δh = 26° ✓
Yellow (76°) → Green (130°): Δh = 54° ✓
Green (130°) → Cyan (190°): Δh = 60° ✓
Cyan (190°) → Blue (252°): Δh = 62° ✓
Blue (252°) → Violet (321°): Δh = 69° ✓
</code></pre><h2 id=foundation-5-color-fatigue-research>Foundation 5: Color Fatigue Research</h2><p>A chromatic pupillometry study [4] found that different wavelengths cause different levels of visual fatigue:</p><ul><li><strong>Red (long wavelength):</strong> Highest fatigue (strongest pupil constriction)</li><li><strong>Yellow:</strong> Lowest fatigue</li><li><strong>Blue/Green:</strong> Intermediate</li></ul><p>The study recommends:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>s</mi><mtext>yellow/green</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&lt;</mo><mn>0.10</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>s</mi><mtext>red</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&lt;</mo><mn>0.09</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>s</mi><mtext>average</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≈</mo><mn>0.08</mn><mtext> (for 8+ hour sessions)</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
s_{\text{yellow/green}} &amp;&lt; 0.10 \\
s_{\text{red}} &amp;&lt; 0.09 \\
s_{\text{average}} &amp;\approx 0.08 \text{ (for 8+ hour sessions)}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:4.5em;vertical-align:-2em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.5em><span style=top:-4.66em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">s</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">yellow/green</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span></span></span><span style=top:-3.16em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">s</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">red</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-1.66em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal">s</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">average</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.5em><span style=top:-4.66em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>&lt;</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.10</span></span></span><span style=top:-3.16em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>&lt;</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.09</span></span></span><span style=top:-1.66em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.08</span><span class="mord text"><span class=mord> (for 8+ hour sessions)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2em><span></span></span></span></span></span></span></span></span></span></span></span><h3 id=saturation-calculation>Saturation Calculation</h3><p>In Oklab, saturation is:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo>=</mo><msqrt><mrow><msup><mi>a</mi><mn>2</mn></msup><mo>+</mo><msup><mi>b</mi><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">
s = \sqrt{a^2 + b^2}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.24em;vertical-align:-.1777em></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.0623em><span class=svg-align style=top:-3.2em><span class=pstrut style=height:3.2em></span><span class=mord style=padding-left:1em><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7401em><span style=top:-2.989em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord><span class="mord mathnormal">b</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7401em><span style=top:-2.989em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style=top:-3.0223em><span class=pstrut style=height:3.2em></span><span class=hide-tail style=min-width:1.02em;height:1.28em><svg width="400em" height="1.28em" viewBox="0 0 4e5 1296" preserveAspectRatio="xMinYMin slice"><path d="M263 681c.7.0 18 39.7 52 119s68.167 158.7 102.5 238c34.3 79.3 51.8 119.3 52.5 120 340-704.7 510.7-1060.3 512-1067 4.7-7.3 11-11 19-11H4e4v40H1012.3L741 687c-38.7 80.7-84 175-136 283s-89.167 185.3-111.5 232c-22.3 46.7-33.8 70.3-34.5 71-4.7 4.7-12.3 7-23 7s-12-1-12-1-109-253-109-253c-72.7-168-109.3-252-110-252-10.7 8-22 16.7-34 26-22 17.3-33.3 26-34 26s-26-26-26-26 76-59 76-59 76-60 76-60zM1001 80h4e5v40h-4e5z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1777em><span></span></span></span></span></span></span></span></span></span><p>For our colors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- Orange: s = √(0.055² + 0.065²) ≈ 0.085 ✓</span>
</span></span><span class=line><span class=cl><span class=n>colors.orange</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.055</span><span class=p>,</span> <span class=mf>0.065</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Red: s = √(0.08² + 0.04²) ≈ 0.089 ✓ (just under 0.09 limit)</span>
</span></span><span class=line><span class=cl><span class=n>colors.red</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.66</span><span class=p>,</span> <span class=mf>0.08</span><span class=p>,</span> <span class=mf>0.04</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Yellow: s = √(0.02² + 0.08²) ≈ 0.082 ✓</span>
</span></span><span class=line><span class=cl><span class=n>colors.yellow</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span> <span class=mf>0.08</span><span class=p>)</span>
</span></span></code></pre></div><p>All saturations are in the low-fatigue zone.</p><h2 id=foundation-6-color-semantics>Foundation 6: Color Semantics</h2><p>Karen Schloss&rsquo;s research [5] on color semantics reveals universal color-concept associations:</p><ul><li><strong>Red</strong> → Danger/Error (cross-cultural)</li><li><strong>Orange</strong> → Action/Warning (warm = activity)</li><li><strong>Yellow</strong> → Important/Attention (high visibility)</li><li><strong>Green</strong> → Success/Content (natural growth)</li><li><strong>Blue</strong> → Logic/Stability (cool = thinking)</li><li><strong>Cyan</strong> → Meta/Frozen (technical concepts)</li></ul><h3 id=deriving-the-ast-token--color-mapping>Deriving the AST Token → Color Mapping</h3><p>Here&rsquo;s how I mapped semantic concepts to code elements using color theory:</p><p><strong>Step 1: Identify code semantic categories</strong></p><p>From TreeSitter and LSP semantic tokens, code elements fall into these categories:</p><ol><li><strong>Control/Flow</strong> - Elements that change execution path</li><li><strong>Behavior</strong> - Functions and actions</li><li><strong>Structure</strong> - Type definitions and declarations</li><li><strong>Data</strong> - Literal values (strings, numbers)</li><li><strong>Meta</strong> - Compile-time constructs (macros, imports)</li><li><strong>Errors</strong> - Diagnostic information</li></ol><p><strong>Step 2: Map to universal color semantics (Schloss 2023)</strong></p><table><thead><tr><th>Code Category</th><th>Semantic Property</th><th>Color Association</th><th>Chosen Color</th></tr></thead><tbody><tr><td>Control/Flow</td><td>Action, Dynamic</td><td>Warm colors (orange/red)</td><td><strong>Orange</strong></td></tr><tr><td>Behavior</td><td>Logic, Stability</td><td>Cool colors (blue)</td><td><strong>Blue</strong></td></tr><tr><td>Structure</td><td>Important, Define</td><td>High visibility (yellow)</td><td><strong>Yellow</strong></td></tr><tr><td>Data (strings)</td><td>Content, Natural</td><td>Growth (green)</td><td><strong>Green</strong></td></tr><tr><td>Data (numbers)</td><td>Abstract</td><td>Neutral (violet)</td><td><strong>Violet</strong></td></tr><tr><td>Meta</td><td>Frozen, Technical</td><td>Cold (cyan)</td><td><strong>Cyan</strong></td></tr><tr><td>Errors</td><td>Danger</td><td>Universal danger (red)</td><td><strong>Red</strong></td></tr></tbody></table><p><strong>Step 3: Apply luminance hierarchy</strong></p><p>Not all categories are equally important. Based on CSF theory and Hannebauer&rsquo;s research:</p><p>Priority 1 (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.68</mn></mrow><annotation encoding="application/x-tex">L=0.68</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.68</span></span></span></span>): Structure elements guide understanding</p><ul><li>Keywords (control flow)</li><li>Functions (behavior)</li><li>Types (declarations)</li></ul><p>Priority 2 (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.66</mn></mrow><annotation encoding="application/x-tex">L=0.66</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.66</span></span></span></span>): Errors need attention but shouldn&rsquo;t dominate</p><ul><li>Diagnostic errors</li></ul><p>Priority 3 (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.64</mn></mrow><annotation encoding="application/x-tex">L=0.64</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.64</span></span></span></span>): Data is secondary to structure</p><ul><li>Strings, numbers, constants</li></ul><p><strong>Step 4: Calculate precise Oklab coordinates</strong></p><p>For each color, I needed to satisfy:</p><ol><li>Correct hue (from color semantics)</li><li>Correct luminance (from CSF hierarchy)</li><li>Safe saturation (from fatigue research)</li><li>Sufficient hue separation (from CIECAM02)</li></ol><p>Example for <strong>Orange</strong> (keywords):</p><ul><li>Target hue: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>≈</mo><mn>50</mn><mi mathvariant="normal">°</mi></mrow><annotation encoding="application/x-tex">h \approx 50°</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal">h</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class=mord>50°</span></span></span></span> (action/warm)</li><li>Target luminance: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.68</mn></mrow><annotation encoding="application/x-tex">L = 0.68</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.68</span></span></span></span> (high priority)</li><li>Target saturation: <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>≈</mo><mn>0.085</mn></mrow><annotation encoding="application/x-tex">s \approx 0.085</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4831em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.085</span></span></span></span> (below 0.10 threshold)</li></ul><p>Converting hue to Oklab <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a, b</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal">a</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal">b</span></span></span></span> coordinates:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>s</mi><mo>×</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>h</mi><mo>×</mo><mi>π</mi><mi mathvariant="normal">/</mi><mn>180</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>s</mi><mo>×</mo><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>h</mi><mo>×</mo><mi>π</mi><mi mathvariant="normal">/</mi><mn>180</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
a &amp;= s \times \cos(h \times \pi / 180) \\
b &amp;= s \times \sin(h \times \pi / 180)
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3em;vertical-align:-1.25em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.75em><span style=top:-3.91em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">a</span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">b</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.25em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.75em><span style=top:-3.91em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class=mop>cos</span><span class=mopen>(</span><span class="mord mathnormal">h</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.03588em>π</span><span class=mord>/180</span><span class=mclose>)</span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class=mop>sin</span><span class=mopen>(</span><span class="mord mathnormal">h</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.03588em>π</span><span class=mord>/180</span><span class=mclose>)</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.25em><span></span></span></span></span></span></span></span></span></span></span></span><p>For <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>50</mn><mi mathvariant="normal">°</mi><mo separator="true">,</mo><mi>s</mi><mo>=</mo><mn>0.085</mn></mrow><annotation encoding="application/x-tex">h = 50°, s = 0.085</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal">h</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class=mord>50°</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal">s</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.085</span></span></span></span>:</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.085</mn><mo>×</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>50</mn><mi mathvariant="normal">°</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>0.055</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.085</mn><mo>×</mo><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>50</mn><mi mathvariant="normal">°</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>0.065</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
a &amp;= 0.085 \times \cos(50°) \approx 0.055 \\
b &amp;= 0.085 \times \sin(50°) \approx 0.065
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3em;vertical-align:-1.25em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.75em><span style=top:-3.91em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">a</span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal">b</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.25em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.75em><span style=top:-3.91em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.085</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class=mop>cos</span><span class=mopen>(</span><span class=mord>50°</span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.055</span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.085</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class=mop>sin</span><span class=mopen>(</span><span class=mord>50°</span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.065</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.25em><span></span></span></span></span></span></span></span></span></span></span></span><p>Therefore: <code>colors.orange = oklab_to_srgb(0.68, 0.055, 0.065)</code></p><p>I repeated this process for all seven colors, ensuring:</p><ul><li>✓ Hue separation <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo><mn>20</mn><mi mathvariant="normal">°</mi></mrow><annotation encoding="application/x-tex">\geq 20°</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7719em;vertical-align:-.136em></span><span class=mrel>≥</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class=mord>20°</span></span></span></span></li><li>✓ Saturation <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>0.10</mn></mrow><annotation encoding="application/x-tex">&lt; 0.10</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class=mrel>&lt;</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.10</span></span></span></span> (<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>0.09</mn></mrow><annotation encoding="application/x-tex">&lt; 0.09</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class=mrel>&lt;</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.09</span></span></span></span> for red)</li><li>✓ Luminance matches priority level</li><li>✓ Semantic alignment with code elements</li></ul><h2 id=complete-implementation>Complete Implementation</h2><p>Here&rsquo;s the final color palette definition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>colors</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Background (neutral, minimal chroma)</span>
</span></span><span class=line><span class=cl><span class=n>colors.bg</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.24</span><span class=p>,</span> <span class=mf>0.001</span><span class=p>,</span> <span class=mf>0.006</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>colors.fg</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.74</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.008</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Layer 1: Core Structure (L=0.68)</span>
</span></span><span class=line><span class=cl><span class=n>colors.orange</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.055</span><span class=p>,</span> <span class=mf>0.065</span><span class=p>)</span>  <span class=c1>-- Keywords</span>
</span></span><span class=line><span class=cl><span class=n>colors.blue</span>   <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.02</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.06</span><span class=p>)</span>  <span class=c1>-- Functions</span>
</span></span><span class=line><span class=cl><span class=n>colors.yellow</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.02</span><span class=p>,</span>  <span class=mf>0.08</span><span class=p>)</span>   <span class=c1>-- Types</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Layer 2: Diagnostics (L=0.66)</span>
</span></span><span class=line><span class=cl><span class=n>colors.red</span>    <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.66</span><span class=p>,</span> <span class=mf>0.08</span><span class=p>,</span>  <span class=mf>0.04</span><span class=p>)</span>   <span class=c1>-- Errors</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Layer 3: Data (L=0.64)</span>
</span></span><span class=line><span class=cl><span class=n>colors.green</span>  <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.64</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.06</span><span class=p>)</span>   <span class=c1>-- Strings</span>
</span></span><span class=line><span class=cl><span class=n>colors.cyan</span>   <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.64</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.055</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.01</span><span class=p>)</span> <span class=c1>-- Constants</span>
</span></span><span class=line><span class=cl><span class=n>colors.violet</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.64</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.04</span><span class=p>)</span>   <span class=c1>-- Numbers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=n>colors</span>
</span></span></code></pre></div><p>And the highlight group mappings that follow the research:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- HIGH PRIORITY: Structure (bright, L=0.68)</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Keyword&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.orange</span> <span class=p>})</span>      <span class=c1>-- Control flow</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Function&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.blue</span> <span class=p>})</span>       <span class=c1>-- Behavior</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Type&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.yellow</span> <span class=p>})</span>         <span class=c1>-- Definitions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- LOW PRIORITY: Data (dimmer, L=0.64)</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;String&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.green</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Constant&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.cyan</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Number&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.violet</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- NEUTRAL: Variables and operators (same as foreground)</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Identifier&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.fg</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>vim.api</span><span class=p>.</span><span class=n>nvim_set_hl</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Operator&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=n>fg</span> <span class=o>=</span> <span class=n>colors.fg</span> <span class=p>})</span>
</span></span></code></pre></div><p>Every value is derived from formulas, not arbitrary hex codes. Every mapping decision is backed by research.</p><h2 id=results>Results</h2><p><a href=https://github.com/glepnir/nvim/blob/main/colors/retina.lua target=_blank rel="noreferrer nofollow">I named it <strong>Retina</strong> a scientifically optimized colorscheme for human vision.</a></p><p><p class=imgp><img loading=lazy src=/images/colorscheme.png alt="Screenshot of the theme in action - Neovim editing C code"></p><em>C code showing the luminance hierarchy in action. Keywords (orange, <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.68</mn></mrow><annotation encoding="application/x-tex">L=0.68</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.68</span></span></span></span>) pop more than strings (green, <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.64</mn></mrow><annotation encoding="application/x-tex">L=0.64</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.64</span></span></span></span>). Errors (red, <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.66</mn></mrow><annotation encoding="application/x-tex">L=0.66</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.66</span></span></span></span>) are immediately visible.</em></p><p>After using this theme for 2 months, the difference is remarkable:</p><ul><li><strong>No more fatigue cycles:</strong> I can code for 10+ hours without eye strain</li><li><strong>Errors are immediately obvious:</strong> The <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.66</mn></mrow><annotation encoding="application/x-tex">L=0.66</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.66</span></span></span></span> layer works perfectly</li><li><strong>Structure is clear:</strong> Keywords/functions/types at <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>0.68</mn></mrow><annotation encoding="application/x-tex">L=0.68</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.68</span></span></span></span> guide my eyes to the code&rsquo;s skeleton</li><li><strong>Variables don&rsquo;t distract:</strong> Neutral colors reduce visual noise by ~75%</li></ul><h2 id=individual-differences-a-note-of-caution>Individual Differences: A Note of Caution</h2><p>It&rsquo;s crucial to understand that vision is deeply personal. This theme was optimized for:</p><ul><li>My personal contrast sensitivity</li><li>My typical viewing distance (~60cm)</li><li>My display (MacBook Pro, ~400 nits)</li><li>My ambient lighting (soft overhead lighting, ~300 lux)</li></ul><p>Your mileage may vary. Factors that affect color perception:</p><ol><li><strong>Age:</strong> Older adults need higher contrast [6]</li><li><strong>Display technology:</strong> OLED vs LCD affects color appearance</li><li><strong>Ambient light:</strong> Outdoor vs indoor viewing</li><li><strong>Individual differences:</strong> Color deficiency affects ~8% of males</li></ol><h3 id=how-to-adapt-this-for-yourself>How to Adapt This for Yourself</h3><p>The beauty of the formula-based approach is that you can adjust the <em>parameters</em> rather than tweaking hex codes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>-- Want more contrast? Increase background-structure ΔL:</span>
</span></span><span class=line><span class=cl><span class=n>colors.orange</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.70</span><span class=p>,</span> <span class=mf>0.055</span><span class=p>,</span> <span class=mf>0.065</span><span class=p>)</span>  <span class=c1>-- was 0.68</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Want lower saturation? Scale the a,b values:</span>
</span></span><span class=line><span class=cl><span class=n>colors.orange</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.044</span><span class=p>,</span> <span class=mf>0.052</span><span class=p>)</span>  <span class=c1>-- was (0.055, 0.065)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- Want warmer tones? Shift hue by adjusting a,b ratio:</span>
</span></span><span class=line><span class=cl><span class=n>colors.orange</span> <span class=o>=</span> <span class=n>oklab_to_srgb</span><span class=p>(</span><span class=mf>0.68</span><span class=p>,</span> <span class=mf>0.050</span><span class=p>,</span> <span class=mf>0.070</span><span class=p>)</span>  <span class=c1>-- more yellow</span>
</span></span></code></pre></div><p>The formulas remain the foundation; you adjust coefficients rather than guessing hex values.</p><h2 id=summary-and-takeaways>Summary and Takeaways</h2><p>What started as frustration with arbitrary theme tweaking led to a systematic, science-based approach:</p><ol><li><strong>Use perceptually uniform color spaces</strong> (Oklab) for predictable color manipulation</li><li><strong>Prioritize luminance hierarchy</strong> (CSF Theory) over hue differences</li><li><strong>Control saturation carefully</strong> (Color Fatigue research) for long-term comfort</li><li><strong>Respect perceptual thresholds</strong> (CIECAM02) for hue discrimination</li><li><strong>Align with semantic expectations</strong> (Color Semantics) for intuitive understanding</li><li><strong>Highlight structure, not noise</strong> (Hannebauer, Tonsky) for clarity</li></ol><p>I hope this approach helps others escape the arbitrary theme-tweaking trap. The science exists—we might as well use it.</p><hr><h2 id=references>References</h2><p>[1] Ottosson, B. (2020). A perceptual color space for image processing. <a href=https://bottosson.github.io/posts/oklab/ target=_blank rel="noreferrer nofollow">https://bottosson.github.io/posts/oklab/</a></p><p>[2] Barten, P. G. J. (1999). <em>Contrast sensitivity of the human eye and its effects on image quality</em>. SPIE Press.</p><p>[3] Fairchild, M. D. (2013). <em>Color appearance models</em> (3rd ed.). John Wiley & Sons.</p><p>[4] Cao, T., Zhang, M., Jiang, Y., Lu, C., & Xu, Y. (2024). Effects of exposure to different light wavelengths on human eye fatigue. <em>PMC</em>, 11175232. <a href=https://www.ncbi.nlm.nih.gov/pmc/articles/PMC11175232/ target=_blank rel="noreferrer nofollow">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC11175232/</a></p><p>[5] Schloss, K. B., & Palmer, S. E. (2024). Color semantics for visual communication. <em>Annual Review of Vision Science</em>, <em>10</em>, 1-25.</p><p>[6] Owsley, C. (2016). Vision and aging. <em>Annual Review of Vision Science</em>, <em>2</em>, 255-271.</p><p>[7] Hannebauer, C., Hesenius, M., & Gruhn, V. (2018). Does syntax highlighting help programming novices? <em>Empirical Software Engineering</em>, <em>23</em>(5), 2795-2828.</p><p>Additional references:</p><ul><li><p>IEC 61966-2-1:1999. Multimedia systems and equipment - Colour measurement and management - Part 2-1: Default RGB colour space - sRGB.</p></li><li><p>Tonsky, I. (2025). Syntax highlighting is a waste of time. <a href=https://tonsky.me/blog/syntax-highlighting/ target=_blank rel="noreferrer nofollow">https://tonsky.me/blog/syntax-highlighting/</a></p></li></ul><hr><p><em>The complete theme is available at <a href=https://github.com/glepnir/nvim/blob/main/colors/retina.lua target=_blank rel="noreferrer nofollow">here</a>. Contributions and adaptations welcome.</em></p></main><div class=sponsor><a href=https://github.com/sponsors/glepnir target=_blank rel="noopener noreferrer" class=sponsor-btn>❤️ Sponsor</a></div><section class=comments><script src=https://giscus.app/client.js data-repo=glepnir/glepnir.github.io data-repo-id data-category=General data-category-id data-mapping=pathname data-strict=0 data-reactions-enabled data-emit-metadata data-input-position data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></section><br><footer class=site-footer><p class=footer-meta>© 2025 glepnir ·
<a href=https://github.com/glepnir>GitHub</a> ·
<a href=https://reddit.com/u/glephunter>Reddit</a> ·
<a href=https://www.functor.me/index.xml>RSS</a></p><script defer>document.addEventListener("keydown",function(e){if(document.activeElement.isContentEditable)return!1;if(document.activeElement.tagName=="INPUT")return!1;if(e.altKey||e.ctrlKey||e.shiftKey)return!1;var t=e.key;if(t==="h")e.preventDefault(),e.stopPropagation(),window.location.href="/";else if(t==="t")e.preventDefault(),e.stopPropagation(),window.location.href=`https://${location.hostname}/tags`;else if(t==="i"){e.preventDefault(),e.stopPropagation();const t=document.querySelectorAll("input");for(let e=0;e<t.length;e++)if(t[e].offsetParent!==null){t[e].selectionStart=t[e].selectionEnd=t[e].value.length,t[e].focus();break}}return!1})</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,200))}setTimeout(scrollHandler,100)</script><script defer>function getTextContentRecursively(e){let t="";if(e.nodeType===Node.TEXT_NODE)return e.textContent||"";for(const n of e.childNodes)t+=getTextContentRecursively(n);return t}function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]:not(.output):not([class*="language-console"])');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=getTextContentRecursively(e);navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script>window.store={"https://www.functor.me/tags/color-science/":{title:"Color-Science",tags:[],content:"",url:"https://www.functor.me/tags/color-science/"},"https://www.functor.me/":{title:"glepnir's blog",tags:[],content:"",url:"https://www.functor.me/"},"https://www.functor.me/tags/neovim/":{title:"Neovim",tags:[],content:"",url:"https://www.functor.me/tags/neovim/"},"https://www.functor.me/tags/oklab/":{title:"Oklab",tags:[],content:"",url:"https://www.functor.me/tags/oklab/"},"https://www.functor.me/posts/":{title:"Posts",tags:[],content:"",url:"https://www.functor.me/posts/"},"https://www.functor.me/tags/":{title:"Tags",tags:[],content:"",url:"https://www.functor.me/tags/"},"https://www.functor.me/posts/colorscheme/":{title:"The Best Theme Isn't the Prettiest—It's the One You Forget Exists",tags:["neovim","color-science","vision-research","oklab"],content:`Over the past few years, I&rsquo;ve created numerous Neovim color schemes. My workflow was always the same: pick an existing theme, adjust its colors in HSL space until they felt comfortable, and use it for a while. But invariably, after several weeks or months, the same pattern emerged—visual fatigue. My eyes would tire faster during long coding sessions, colors that once felt &ldquo;right&rdquo; started to irritate, and I&rsquo;d find myself tweaking values again and again.
The cycle was frustrating: find theme → adjust → use → fatigue → repeat. Each iteration felt arbitrary. I was working blind, relying purely on subjective perception without understanding why certain colors caused fatigue and others didn&rsquo;t.
This is the story of how I broke that cycle by building a color scheme from scientific first principles.
The Insight: Color Science Exists for a Reason The breakthrough came when I realized: vision scientists have spent decades studying exactly these problems. Research exists on:
How the human eye perceives contrast (Contrast Sensitivity Function) Which color spaces are perceptually uniform (Oklab, CIELAB) What causes color-induced visual fatigue (chromatic pupillometry studies) How colors map to semantic meaning across cultures (color semantics research) What syntax elements should be highlighted (empirical programming research) Instead of adjusting colors arbitrarily in HSL space, I could derive them from scientific principles.
Foundation 1: Perceptual Color Spaces The Problem with RGB and HSL RGB and HSL are convenient for computers but terrible for human perception. In RGB, the distance between #FF0000 (red) and #FF0011 (slightly different red) has no relationship to how different they appear to our eyes. HSL is better but still suffers from perceptual non-uniformity.
Enter Oklab Oklab [1] is a perceptually uniform color space designed by Björn Ottosson. In Oklab:
Euclidean distance corresponds to perceived color difference Lightness (L) separates from chroma Hue manipulation is more intuitive The transformation from Oklab to RGB involves four steps:
Step 1: Oklab → LMS (cone response)
[lms]=[10.39630.21581−0.1056−0.06391−0.0895−1.2915][Lab] \\begin{bmatrix} l \\\\ m \\\\ s \\end{bmatrix} = \\begin{bmatrix} 1 &amp; 0.3963 &amp; 0.2158 \\\\ 1 &amp; -0.1056 &amp; -0.0639 \\\\ 1 &amp; -0.0895 &amp; -1.2915 \\end{bmatrix} \\begin{bmatrix} L \\\\ a \\\\ b \\end{bmatrix} ​lms​​=​111​0.3963−0.1056−0.0895​0.2158−0.0639−1.2915​​​Lab​​Step 2: Inverse cube root
LMSlinear=[l3,m3,s3]T \\text{LMS}_{\\text{linear}} = [l^3, m^3, s^3]^T LMSlinear​=[l3,m3,s3]TStep 3: LMS → Linear RGB
[RGB]=[4.0767−3.30770.2310−1.26842.6098−0.3413−0.0042−0.70341.7076][l3m3s3] \\begin{bmatrix} R \\\\ G \\\\ B \\end{bmatrix} = \\begin{bmatrix} 4.0767 &amp; -3.3077 &amp; 0.2310 \\\\ -1.2684 &amp; 2.6098 &amp; -0.3413 \\\\ -0.0042 &amp; -0.7034 &amp; 1.7076 \\end{bmatrix} \\begin{bmatrix} l^3 \\\\ m^3 \\\\ s^3 \\end{bmatrix} ​RGB​​=​4.0767−1.2684−0.0042​−3.30772.6098−0.7034​0.2310−0.34131.7076​​​l3m3s3​​Step 4: Gamma correction (sRGB)
CsRGB={12.92×Clinearif Clinear≤0.00313081.055×Clinear1/2.4−0.055otherwise C_{\\text{sRGB}} = \\begin{cases} 12.92 \\times C_{\\text{linear}} &amp; \\text{if } C_{\\text{linear}} \\leq 0.0031308 \\\\ 1.055 \\times C_{\\text{linear}}^{1/2.4} - 0.055 &amp; \\text{otherwise} \\end{cases} CsRGB​={12.92×Clinear​1.055×Clinear1/2.4​−0.055​if Clinear​≤0.0031308otherwise​Implementation in Lua local function oklab_to_linear_rgb(L, a, b) -- Step 1: Oklab to LMS local l = L + 0.3963377774 * a + 0.2158037573 * b local m = L - 0.1055613458 * a - 0.0638541728 * b local s = L - 0.0894841775 * a - 1.2914855480 * b -- Step 2: Inverse cube root local l3, m3, s3 = l * l * l, m * m * m, s * s * s -- Step 3: LMS to linear RGB local r = 4.0767416621 * l3 - 3.3077115913 * m3 + 0.2309699292 * s3 local g = -1.2684380046 * l3 + 2.6097574011 * m3 - 0.3413193965 * s3 local b_out = -0.0041960863 * l3 - 0.7034186147 * m3 + 1.7076147010 * s3 return r, g, b_out end local function linear_to_srgb_component(c) -- Step 4: Gamma correction if c &lt;= 0.0031308 then return c * 12.92 else return 1.055 * (c ^ (1 / 2.4)) - 0.055 end end local function oklab_to_srgb(L, a, b) local r, g, b_comp = oklab_to_linear_rgb(L, a, b) r = linear_to_srgb_component(r) g = linear_to_srgb_component(g) b_comp = linear_to_srgb_component(b_comp) -- Clamp and convert to 8-bit r = math.floor(math.max(0, math.min(1, r)) * 255 + 0.5) g = math.floor(math.max(0, math.min(1, g)) * 255 + 0.5) b_comp = math.floor(math.max(0, math.min(1, b_comp)) * 255 + 0.5) return string.format(&#39;#%02x%02x%02x&#39;, r, g, b_comp) end Now I can specify colors as perceptual properties rather than hex codes:
-- Instead of: local orange = &#34;#c5895b&#34; -- I write: local orange = oklab_to_srgb(0.68, 0.055, 0.065) The formula is the color. No more arbitrary hex values.
Foundation 2: What to Highlight - Empirical Research Before deciding how to color code elements, I needed to understand which elements should be highlighted at all.
Hannebauer et al. (2018): The Surprising Truth About Syntax Highlighting A study with 390 programming novices [7] found something surprising:
&ldquo;Syntax highlighting has no significant effect on code comprehension or correctness&rdquo;
But the study revealed a crucial insight: highlighting does help when it emphasizes structural elements rather than coloring everything equally. The key principle:
Highlight structure, minimize noise.
Tonsky (2025): The Neutral Variables Principle Ivan Tonsky&rsquo;s analysis revealed why most themes feel noisy:
&ldquo;Your code is mostly references to variables and method invocation. If we highlight those, we&rsquo;ll have to highlight more than 75% of your code.&rdquo;
His recommendation: Keep variables and operators neutral (same color as regular text). Only highlight structural elements.
From Research to Design Decisions These findings led to my core highlighting strategy:
Highlight (bright colors):
Control flow keywords (if, for, while, return) Function definitions Type declarations Keep neutral (regular text color):
Variable names Operators Function parameters Dim (lower luminance):
Comments Delimiters This creates a visual hierarchy where code structure &ldquo;pops&rdquo; while the majority of text remains calm.
Foundation 3: Contrast Sensitivity Function (CSF) The human visual system doesn&rsquo;t respond uniformly to all contrasts. Barten&rsquo;s CSF model [2] reveals that we are 5-10× more sensitive to luminance contrast than chromatic contrast.
Key Insight: Luminance Hierarchy Matters More Than Hue This was the game-changer. Instead of asking &ldquo;should keywords be orange or yellow?&rdquo;, I should ask &ldquo;should keywords be brighter than data?&rdquo;
Deriving the Three-Layer Luminance Hierarchy I needed to design a luminance hierarchy that satisfies:
CSF comfort threshold: ΔL≥0.02\\Delta L \\geq 0.02ΔL≥0.02 for comfortable discrimination WCAG accessibility: Adequate contrast ratios with background Perceptual distinctness: Each layer feels clearly different Starting constraints:
Background: Lbg=0.24L_{\\text{bg}} = 0.24Lbg​=0.24 (dark theme, reduces eye strain) Foreground: Lfg=0.74L_{\\text{fg}} = 0.74Lfg​=0.74 (7.0:1 contrast, WCAG AAA)
Layer assignment based on Hannebauer (2018):
Layer 1 (highest): Structure (keywords, functions, types) - most important for comprehension Layer 2 (middle): Errors - need prominence without overwhelming Layer 3 (lowest): Data (strings, numbers) - secondary importance Calculating optimal luminance values:
The total usable luminance range is: Lfg−Lbg=0.74−0.24=0.50L_{\\text{fg}} - L_{\\text{bg}} = 0.74 - 0.24 = 0.50Lfg​−Lbg​=0.74−0.24=0.50
For syntax colors, I reserved the upper portion of this range to maintain sufficient contrast with background. Working backwards from foreground:
Lreserve=0.06 (headroom from foreground)Lmax_syntax=0.74−0.06=0.68 \\begin{aligned} L_{\\text{reserve}} &amp;= 0.06 \\text{ (headroom from foreground)} \\\\ L_{\\text{max\\_syntax}} &amp;= 0.74 - 0.06 = 0.68 \\end{aligned} Lreserve​Lmax_syntax​​=0.06 (headroom from foreground)=0.74−0.06=0.68​Now applying the CSF minimum threshold ΔL=0.02\\Delta L = 0.02ΔL=0.02:
Layer 1 (Structure):L1=0.68Layer 2 (Diagnostics):L2=L1−0.02=0.66Layer 3 (Data):L3=L2−0.02=0.64 \\begin{aligned} \\text{Layer 1 (Structure):} &amp;\\quad L_1 = 0.68 \\\\ \\text{Layer 2 (Diagnostics):} &amp;\\quad L_2 = L_1 - 0.02 = 0.66 \\\\ \\text{Layer 3 (Data):} &amp;\\quad L_3 = L_2 - 0.02 = 0.64 \\end{aligned} Layer 1 (Structure):Layer 2 (Diagnostics):Layer 3 (Data):​L1​=0.68L2​=L1​−0.02=0.66L3​=L2​−0.02=0.64​Verification against WCAG:
Using the contrast ratio formula CR=L1+0.05L2+0.05\\text{CR} = \\frac{L_1 + 0.05}{L_2 + 0.05}CR=L2​+0.05L1​+0.05​:
CR(L1,Lbg)=0.68+0.050.24+0.05=5.52:1(AA)CR(L2,Lbg)=0.66+0.050.24+0.05=5.03:1(AA)CR(L3,Lbg)=0.64+0.050.24+0.05=4.76:1(AA) \\begin{aligned} \\text{CR}(L_1, L_{\\text{bg}}) &amp;= \\frac{0.68 + 0.05}{0.24 + 0.05} = 5.52:1 \\quad \\text{(AA)} \\\\ \\text{CR}(L_2, L_{\\text{bg}}) &amp;= \\frac{0.66 + 0.05}{0.24 + 0.05} = 5.03:1 \\quad \\text{(AA)} \\\\ \\text{CR}(L_3, L_{\\text{bg}}) &amp;= \\frac{0.64 + 0.05}{0.24 + 0.05} = 4.76:1 \\quad \\text{(AA)} \\end{aligned} CR(L1​,Lbg​)CR(L2​,Lbg​)CR(L3​,Lbg​)​=0.24+0.050.68+0.05​=5.52:1(AA)=0.24+0.050.66+0.05​=5.03:1(AA)=0.24+0.050.64+0.05​=4.76:1(AA)​All three layers meet WCAG AA standards while maintaining ΔL=0.02\\Delta L = 0.02ΔL=0.02 separation.
Why this matters: In my old themes, I had errors (L=0.64L=0.64L=0.64) at the same brightness as strings. Errors weren&rsquo;t visually salient! Now errors are a distinct layer (L=0.66L=0.66L=0.66), immediately noticeable but not overwhelming.
Perceptual validation:
The 3-layer system creates three distinct &ldquo;brightness tiers&rdquo;:
Tier 1 (L=0.68L=0.68L=0.68): Code structure stands out, guides the eye Tier 2 (L=0.66L=0.66L=0.66): Errors pop without dominating Tier 3 (L=0.64L=0.64L=0.64): Data recedes appropriately This matches the importance hierarchy from Hannebauer&rsquo;s research: structure &gt; errors &gt; data.
Summary: The CSF-Optimized Luminance Hierarchy Layer Luminance Elements Rationale 1 L=0.68L=0.68L=0.68 Keywords, Functions, Types Highest importance for comprehension 2 L=0.66L=0.66L=0.66 Errors, Diagnostics Need prominence, not dominance 3 L=0.64L=0.64L=0.64 Strings, Numbers, Constants Secondary to structure - L=0.24L=0.24L=0.24 Background Low strain for long sessions - L=0.74L=0.74L=0.74 Foreground text 7.0:1 contrast (AAA) Key properties:
ΔL=0.02\\Delta L = 0.02ΔL=0.02 between layers (CSF comfortable threshold) All layers meet WCAG AA (contrast ≥4.5:1\\geq 4.5:1≥4.5:1) Total range: 0.64-0.68 (focused, not excessive) Foundation 4: CIECAM02 Color Appearance Model CIECAM02 [3] helps us understand how colors appear under different viewing conditions. The simplified chroma calculation is:
C≈100×s×J C \\approx 100 \\times s \\times \\sqrt{J} C≈100×s×J​where sss is saturation and JJJ is lightness (0-100 scale).
For comfortable long-term viewing, chroma should be in the range [30, 100]. This constrains our saturation:
s=C100×J s = \\frac{C}{100 \\times \\sqrt{J}} s=100×J​C​For L≈0.65L \\approx 0.65L≈0.65 (corresponding to J≈65J \\approx 65J≈65):
srecommended=65100×65≈0.081 s_{\\text{recommended}} = \\frac{65}{100 \\times \\sqrt{65}} \\approx 0.081 srecommended​=100×65​65​≈0.081This gives us the target saturation range: s∈[0.06,0.12]s \\in [0.06, 0.12]s∈[0.06,0.12].
Hue Discrimination CIECAM02 also tells us that for low-saturation colors, we need a minimum hue separation:
Δh≥20° to 25° \\Delta h \\geq 20° \\text{ to } 25° Δh≥20° to 25°I verified all adjacent hues meet this:
Red (27°) → Orange (50°): Δh = 23° ✓ Orange (50°) → Yellow (76°): Δh = 26° ✓ Yellow (76°) → Green (130°): Δh = 54° ✓ Green (130°) → Cyan (190°): Δh = 60° ✓ Cyan (190°) → Blue (252°): Δh = 62° ✓ Blue (252°) → Violet (321°): Δh = 69° ✓ Foundation 5: Color Fatigue Research A chromatic pupillometry study [4] found that different wavelengths cause different levels of visual fatigue:
Red (long wavelength): Highest fatigue (strongest pupil constriction) Yellow: Lowest fatigue Blue/Green: Intermediate The study recommends:
syellow/green&lt;0.10sred&lt;0.09saverage≈0.08 (for 8+ hour sessions) \\begin{aligned} s_{\\text{yellow/green}} &amp;&lt; 0.10 \\\\ s_{\\text{red}} &amp;&lt; 0.09 \\\\ s_{\\text{average}} &amp;\\approx 0.08 \\text{ (for 8+ hour sessions)} \\end{aligned} syellow/green​sred​saverage​​&lt;0.10&lt;0.09≈0.08 (for 8+ hour sessions)​Saturation Calculation In Oklab, saturation is:
s=a2+b2 s = \\sqrt{a^2 + b^2} s=a2+b2​For our colors:
-- Orange: s = √(0.055² + 0.065²) ≈ 0.085 ✓ colors.orange = oklab_to_srgb(0.68, 0.055, 0.065) -- Red: s = √(0.08² + 0.04²) ≈ 0.089 ✓ (just under 0.09 limit) colors.red = oklab_to_srgb(0.66, 0.08, 0.04) -- Yellow: s = √(0.02² + 0.08²) ≈ 0.082 ✓ colors.yellow = oklab_to_srgb(0.68, 0.02, 0.08) All saturations are in the low-fatigue zone.
Foundation 6: Color Semantics Karen Schloss&rsquo;s research [5] on color semantics reveals universal color-concept associations:
Red → Danger/Error (cross-cultural) Orange → Action/Warning (warm = activity) Yellow → Important/Attention (high visibility) Green → Success/Content (natural growth) Blue → Logic/Stability (cool = thinking) Cyan → Meta/Frozen (technical concepts) Deriving the AST Token → Color Mapping Here&rsquo;s how I mapped semantic concepts to code elements using color theory:
Step 1: Identify code semantic categories
From TreeSitter and LSP semantic tokens, code elements fall into these categories:
Control/Flow - Elements that change execution path Behavior - Functions and actions Structure - Type definitions and declarations Data - Literal values (strings, numbers) Meta - Compile-time constructs (macros, imports) Errors - Diagnostic information Step 2: Map to universal color semantics (Schloss 2023)
Code Category Semantic Property Color Association Chosen Color Control/Flow Action, Dynamic Warm colors (orange/red) Orange Behavior Logic, Stability Cool colors (blue) Blue Structure Important, Define High visibility (yellow) Yellow Data (strings) Content, Natural Growth (green) Green Data (numbers) Abstract Neutral (violet) Violet Meta Frozen, Technical Cold (cyan) Cyan Errors Danger Universal danger (red) Red Step 3: Apply luminance hierarchy
Not all categories are equally important. Based on CSF theory and Hannebauer&rsquo;s research:
Priority 1 (L=0.68L=0.68L=0.68): Structure elements guide understanding
Keywords (control flow) Functions (behavior) Types (declarations) Priority 2 (L=0.66L=0.66L=0.66): Errors need attention but shouldn&rsquo;t dominate
Diagnostic errors Priority 3 (L=0.64L=0.64L=0.64): Data is secondary to structure
Strings, numbers, constants Step 4: Calculate precise Oklab coordinates
For each color, I needed to satisfy:
Correct hue (from color semantics) Correct luminance (from CSF hierarchy) Safe saturation (from fatigue research) Sufficient hue separation (from CIECAM02) Example for Orange (keywords):
Target hue: h≈50°h \\approx 50°h≈50° (action/warm) Target luminance: L=0.68L = 0.68L=0.68 (high priority) Target saturation: s≈0.085s \\approx 0.085s≈0.085 (below 0.10 threshold) Converting hue to Oklab a,ba, ba,b coordinates:
a=s×cos⁡(h×π/180)b=s×sin⁡(h×π/180) \\begin{aligned} a &amp;= s \\times \\cos(h \\times \\pi / 180) \\\\ b &amp;= s \\times \\sin(h \\times \\pi / 180) \\end{aligned} ab​=s×cos(h×π/180)=s×sin(h×π/180)​For h=50°,s=0.085h = 50°, s = 0.085h=50°,s=0.085:
a=0.085×cos⁡(50°)≈0.055b=0.085×sin⁡(50°)≈0.065 \\begin{aligned} a &amp;= 0.085 \\times \\cos(50°) \\approx 0.055 \\\\ b &amp;= 0.085 \\times \\sin(50°) \\approx 0.065 \\end{aligned} ab​=0.085×cos(50°)≈0.055=0.085×sin(50°)≈0.065​Therefore: colors.orange = oklab_to_srgb(0.68, 0.055, 0.065)
I repeated this process for all seven colors, ensuring:
✓ Hue separation ≥20°\\geq 20°≥20° ✓ Saturation &lt;0.10&lt; 0.10&lt;0.10 (&lt;0.09&lt; 0.09&lt;0.09 for red) ✓ Luminance matches priority level ✓ Semantic alignment with code elements Complete Implementation Here&rsquo;s the final color palette definition:
local colors = {} -- Background (neutral, minimal chroma) colors.bg = oklab_to_srgb(0.24, 0.001, 0.006) colors.fg = oklab_to_srgb(0.74, 0.0, 0.008) -- Layer 1: Core Structure (L=0.68) colors.orange = oklab_to_srgb(0.68, 0.055, 0.065) -- Keywords colors.blue = oklab_to_srgb(0.68, -0.02, -0.06) -- Functions colors.yellow = oklab_to_srgb(0.68, 0.02, 0.08) -- Types -- Layer 2: Diagnostics (L=0.66) colors.red = oklab_to_srgb(0.66, 0.08, 0.04) -- Errors -- Layer 3: Data (L=0.64) colors.green = oklab_to_srgb(0.64, -0.05, 0.06) -- Strings colors.cyan = oklab_to_srgb(0.64, -0.055, -0.01) -- Constants colors.violet = oklab_to_srgb(0.64, 0.05, -0.04) -- Numbers return colors And the highlight group mappings that follow the research:
-- HIGH PRIORITY: Structure (bright, L=0.68) vim.api.nvim_set_hl(0, &#39;Keyword&#39;, { fg = colors.orange }) -- Control flow vim.api.nvim_set_hl(0, &#39;Function&#39;, { fg = colors.blue }) -- Behavior vim.api.nvim_set_hl(0, &#39;Type&#39;, { fg = colors.yellow }) -- Definitions -- LOW PRIORITY: Data (dimmer, L=0.64) vim.api.nvim_set_hl(0, &#39;String&#39;, { fg = colors.green }) vim.api.nvim_set_hl(0, &#39;Constant&#39;, { fg = colors.cyan }) vim.api.nvim_set_hl(0, &#39;Number&#39;, { fg = colors.violet }) -- NEUTRAL: Variables and operators (same as foreground) vim.api.nvim_set_hl(0, &#39;Identifier&#39;, { fg = colors.fg }) vim.api.nvim_set_hl(0, &#39;Operator&#39;, { fg = colors.fg }) Every value is derived from formulas, not arbitrary hex codes. Every mapping decision is backed by research.
Results I named it Retina a scientifically optimized colorscheme for human vision.
C code showing the luminance hierarchy in action. Keywords (orange, L=0.68L=0.68L=0.68) pop more than strings (green, L=0.64L=0.64L=0.64). Errors (red, L=0.66L=0.66L=0.66) are immediately visible.
After using this theme for 2 months, the difference is remarkable:
No more fatigue cycles: I can code for 10+ hours without eye strain Errors are immediately obvious: The L=0.66L=0.66L=0.66 layer works perfectly Structure is clear: Keywords/functions/types at L=0.68L=0.68L=0.68 guide my eyes to the code&rsquo;s skeleton Variables don&rsquo;t distract: Neutral colors reduce visual noise by ~75% Individual Differences: A Note of Caution It&rsquo;s crucial to understand that vision is deeply personal. This theme was optimized for:
My personal contrast sensitivity My typical viewing distance (~60cm) My display (MacBook Pro, ~400 nits) My ambient lighting (soft overhead lighting, ~300 lux) Your mileage may vary. Factors that affect color perception:
Age: Older adults need higher contrast [6] Display technology: OLED vs LCD affects color appearance Ambient light: Outdoor vs indoor viewing Individual differences: Color deficiency affects ~8% of males How to Adapt This for Yourself The beauty of the formula-based approach is that you can adjust the parameters rather than tweaking hex codes:
-- Want more contrast? Increase background-structure ΔL: colors.orange = oklab_to_srgb(0.70, 0.055, 0.065) -- was 0.68 -- Want lower saturation? Scale the a,b values: colors.orange = oklab_to_srgb(0.68, 0.044, 0.052) -- was (0.055, 0.065) -- Want warmer tones? Shift hue by adjusting a,b ratio: colors.orange = oklab_to_srgb(0.68, 0.050, 0.070) -- more yellow The formulas remain the foundation; you adjust coefficients rather than guessing hex values.
Summary and Takeaways What started as frustration with arbitrary theme tweaking led to a systematic, science-based approach:
Use perceptually uniform color spaces (Oklab) for predictable color manipulation Prioritize luminance hierarchy (CSF Theory) over hue differences Control saturation carefully (Color Fatigue research) for long-term comfort Respect perceptual thresholds (CIECAM02) for hue discrimination Align with semantic expectations (Color Semantics) for intuitive understanding Highlight structure, not noise (Hannebauer, Tonsky) for clarity I hope this approach helps others escape the arbitrary theme-tweaking trap. The science exists—we might as well use it.
References [1] Ottosson, B. (2020). A perceptual color space for image processing. https://bottosson.github.io/posts/oklab/
[2] Barten, P. G. J. (1999). Contrast sensitivity of the human eye and its effects on image quality. SPIE Press.
[3] Fairchild, M. D. (2013). Color appearance models (3rd ed.). John Wiley &amp; Sons.
[4] Cao, T., Zhang, M., Jiang, Y., Lu, C., &amp; Xu, Y. (2024). Effects of exposure to different light wavelengths on human eye fatigue. PMC, 11175232. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC11175232/
[5] Schloss, K. B., &amp; Palmer, S. E. (2024). Color semantics for visual communication. Annual Review of Vision Science, 10, 1-25.
[6] Owsley, C. (2016). Vision and aging. Annual Review of Vision Science, 2, 255-271.
[7] Hannebauer, C., Hesenius, M., &amp; Gruhn, V. (2018). Does syntax highlighting help programming novices? Empirical Software Engineering, 23(5), 2795-2828.
Additional references:
IEC 61966-2-1:1999. Multimedia systems and equipment - Colour measurement and management - Part 2-1: Default RGB colour space - sRGB.
Tonsky, I. (2025). Syntax highlighting is a waste of time. https://tonsky.me/blog/syntax-highlighting/
The complete theme is available at here. Contributions and adaptations welcome.
`,url:"https://www.functor.me/posts/colorscheme/"},"https://www.functor.me/tags/vision-research/":{title:"Vision-Research",tags:[],content:"",url:"https://www.functor.me/tags/vision-research/"},"https://www.functor.me/categories/":{title:"Categories",tags:[],content:"",url:"https://www.functor.me/categories/"}}</script></footer></body></html>