<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Go Context Package Usage - glepnir blog</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Go Context Package Usage"><meta property="og:description" content="Let’s start with the main function that will really only create the router and the routes."><meta property="og:type" content="article"><meta property="og:url" content="/post/go/context-usage/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-09-06T16:38:23+08:00"><meta property="article:modified_time" content="2022-09-06T16:38:23+08:00"><meta itemprop=name content="Go Context Package Usage"><meta itemprop=description content="Let’s start with the main function that will really only create the router and the routes."><meta itemprop=datePublished content="2022-09-06T16:38:23+08:00"><meta itemprop=dateModified content="2022-09-06T16:38:23+08:00"><meta itemprop=wordCount content="694"><meta itemprop=keywords content="go,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Context Package Usage"><meta name=twitter:description content="Let’s start with the main function that will really only create the router and the routes."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div></div><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="glepnir's blog" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/images/avatar.svg></div><div class="logo__item logo__text"><div class=logo__title>glepnir's blog</div><div class=logo__tagline>A vimer work at neovim team</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>tags</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>about</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Go Context Package Usage</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>glepnir</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-09-06T16:38:23+08:00>2022-09-06</time></div></div></header><div class="content post__content clearfix"><p>Let’s start with the main function that will really only create the router and the routes.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>	mux <span style=color:#719e07>:=</span> http.<span style=color:#268bd2>NewServeMux</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.<span style=color:#268bd2>HandleFunc</span>(<span style=color:#2aa198>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#268bd2>HandleFunc</span>(<span style=color:#2aa198>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#268bd2>HandleFunc</span>(<span style=color:#2aa198>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.<span style=color:#268bd2>Println</span>(<span style=color:#2aa198>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	log.<span style=color:#268bd2>Fatal</span>(http.<span style=color:#268bd2>ListenAndServe</span>(<span style=color:#2aa198>&#34;:8085&#34;</span>, mux))
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>Our example will allow you to login and logout and once logged in we will put a “hardcoded” username in the context to flow to the StatusPage handler. So this is 3 routes:</p><ul><li>/login</li><li>/logout</li><li>/</li></ul><p>Login and Logout are simply done by visiting the route where we add and remove a cookie. Now to cerate the skeletons of the 3 handlers:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>StatusPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	w.<span style=color:#268bd2>Write</span>([]<span style=color:#b58900>byte</span>(<span style=color:#2aa198>&#34;This Page will show the context username once the context is added.&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>LoginPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#719e07>:=</span> time.<span style=color:#268bd2>Now</span>().<span style=color:#268bd2>Add</span>(<span style=color:#2aa198>365</span> <span style=color:#719e07>*</span> <span style=color:#2aa198>24</span> <span style=color:#719e07>*</span> time.Hour)  <span style=color:#586e75>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>	cookie <span style=color:#719e07>:=</span> http.Cookie{Name: <span style=color:#2aa198>&#34;username&#34;</span>, Value: <span style=color:#2aa198>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#268bd2>SetCookie</span>(w, <span style=color:#719e07>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>LogoutPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#719e07>:=</span> time.<span style=color:#268bd2>Now</span>().<span style=color:#268bd2>AddDate</span>(<span style=color:#2aa198>0</span>, <span style=color:#2aa198>0</span>, <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>)	<span style=color:#586e75>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>	cookie <span style=color:#719e07>:=</span> http.Cookie{Name: <span style=color:#2aa198>&#34;username&#34;</span>, Value: <span style=color:#2aa198>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#268bd2>SetCookie</span>(w, <span style=color:#719e07>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now the fun part to add context to the requests… First we’ll need to create middleware and use it in the router. Middleware is simply a function that accepts an http handler and returns an http.handler. In this simple example I will call the middleware component “AddContext” and in the returned handler I will first check to make sure we are logged by looking for the login cookie and if it is set then we place the data we want in the request’s context and call the next handler which was passed in as an argument…</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>AddContext</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#719e07>return</span> http.<span style=color:#268bd2>HandlerFunc</span>(<span style=color:#268bd2>func</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>		log.<span style=color:#268bd2>Println</span>(r.Method, <span style=color:#2aa198>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ <span style=color:#719e07>:=</span> r.<span style=color:#268bd2>Cookie</span>(<span style=color:#2aa198>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#719e07>if</span> cookie <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#586e75>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>			ctx <span style=color:#719e07>:=</span> context.<span style=color:#268bd2>WithValue</span>(r.<span style=color:#268bd2>Context</span>(), <span style=color:#2aa198>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.<span style=color:#268bd2>ServeHTTP</span>(w, r.<span style=color:#268bd2>WithContext</span>(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>			next.<span style=color:#268bd2>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As well we need to use that new middleware in the router and we do that in 1 or 2 ways…</p><p>First we can add the context only to specific routes, like so:</p><ul><li>mux.HandleFunc(“/”, StatusPage)</li></ul><p>becomes:</p><ul><li>mux.Handle(“/”, AddContext(http.HandlerFunc(StatusPage)))</li></ul><p>Or second, we can add it to the router itself:</p><ul><li>log.Println(“Start server on port :8085”)</li><li>log.Fatal(http.ListenAndServe(”:8085”, mux))</li></ul><p>becomes</p><ul><li>log.Println(“Start server on port :8085”)</li><li>contextedMux := AddContext(mux)</li><li>log.Fatal(http.ListenAndServe(”:8085”, contextedMux))
Once you have done all this we can now modify the ‘StatusPage’ handler to look for and react to the data that is now in the context.</li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>StatusPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#586e75>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>	<span style=color:#719e07>if</span> username <span style=color:#719e07>:=</span> r.<span style=color:#268bd2>Context</span>().<span style=color:#268bd2>Value</span>(<span style=color:#2aa198>&#34;Username&#34;</span>); username <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>Write</span>([]<span style=color:#b58900>byte</span>(<span style=color:#2aa198>&#34;Hello &#34;</span> <span style=color:#719e07>+</span> username.(<span style=color:#dc322f>string</span>) <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>WriteHeader</span>(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>Write</span>([]<span style=color:#b58900>byte</span>(<span style=color:#2aa198>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It’s good to note that once we get the data out of the context we need to (cast) it to the proper type to use it. This is because the context Value() function returns an interface{} type. ( – See: ‘username.(string)’ )</p><p>I hope this quick intro to usign the Context object is useful, also I might write in the future about context With Cancel, Deadline and Timeout as they can also be useful in many scenarios.</p><p>Check out the entire code for this article below…</p><p>Happy GOing!!</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#2aa198>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#2aa198>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#2aa198>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#2aa198>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>AddContext</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>	<span style=color:#719e07>return</span> http.<span style=color:#268bd2>HandlerFunc</span>(<span style=color:#268bd2>func</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>		log.<span style=color:#268bd2>Println</span>(r.Method, <span style=color:#2aa198>&#34;-&#34;</span>, r.RequestURI)
</span></span><span style=display:flex><span>		cookie, _ <span style=color:#719e07>:=</span> r.<span style=color:#268bd2>Cookie</span>(<span style=color:#2aa198>&#34;username&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#719e07>if</span> cookie <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#586e75>//Add data to context
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>			ctx <span style=color:#719e07>:=</span> context.<span style=color:#268bd2>WithValue</span>(r.<span style=color:#268bd2>Context</span>(), <span style=color:#2aa198>&#34;Username&#34;</span>, cookie.Value)
</span></span><span style=display:flex><span>			next.<span style=color:#268bd2>ServeHTTP</span>(w, r.<span style=color:#268bd2>WithContext</span>(ctx))
</span></span><span style=display:flex><span>		} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>			next.<span style=color:#268bd2>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>StatusPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	<span style=color:#586e75>//Get data from context
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>	<span style=color:#719e07>if</span> username <span style=color:#719e07>:=</span> r.<span style=color:#268bd2>Context</span>().<span style=color:#268bd2>Value</span>(<span style=color:#2aa198>&#34;Username&#34;</span>); username <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>Write</span>([]<span style=color:#b58900>byte</span>(<span style=color:#2aa198>&#34;Hello &#34;</span> <span style=color:#719e07>+</span> username.(<span style=color:#dc322f>string</span>) <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>	} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>WriteHeader</span>(http.StatusNotFound)
</span></span><span style=display:flex><span>		w.<span style=color:#268bd2>Write</span>([]<span style=color:#b58900>byte</span>(<span style=color:#2aa198>&#34;Not Logged in&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>LoginPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#719e07>:=</span> time.<span style=color:#268bd2>Now</span>().<span style=color:#268bd2>Add</span>(<span style=color:#2aa198>365</span> <span style=color:#719e07>*</span> <span style=color:#2aa198>24</span> <span style=color:#719e07>*</span> time.Hour)  <span style=color:#586e75>////Set to expire in 1 year
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>	cookie <span style=color:#719e07>:=</span> http.Cookie{Name: <span style=color:#2aa198>&#34;username&#34;</span>, Value: <span style=color:#2aa198>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#268bd2>SetCookie</span>(w, <span style=color:#719e07>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>LogoutPage</span>(w http.ResponseWriter, r <span style=color:#719e07>*</span>http.Request) {
</span></span><span style=display:flex><span>	expiration <span style=color:#719e07>:=</span> time.<span style=color:#268bd2>Now</span>().<span style=color:#268bd2>AddDate</span>(<span style=color:#2aa198>0</span>, <span style=color:#2aa198>0</span>, <span style=color:#719e07>-</span><span style=color:#2aa198>1</span>)	<span style=color:#586e75>//Set to expire in the past
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>	cookie <span style=color:#719e07>:=</span> http.Cookie{Name: <span style=color:#2aa198>&#34;username&#34;</span>, Value: <span style=color:#2aa198>&#34;alice_cooper@gmail.com&#34;</span>, Expires: expiration}
</span></span><span style=display:flex><span>	http.<span style=color:#268bd2>SetCookie</span>(w, <span style=color:#719e07>&amp;</span>cookie)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>	mux <span style=color:#719e07>:=</span> http.<span style=color:#268bd2>NewServeMux</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mux.<span style=color:#268bd2>HandleFunc</span>(<span style=color:#2aa198>&#34;/&#34;</span>, StatusPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#268bd2>HandleFunc</span>(<span style=color:#2aa198>&#34;/login&#34;</span>, LoginPage)
</span></span><span style=display:flex><span>	mux.<span style=color:#268bd2>HandleFunc</span>(<span style=color:#2aa198>&#34;/logout&#34;</span>, LogoutPage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	log.<span style=color:#268bd2>Println</span>(<span style=color:#2aa198>&#34;Start server on port :8085&#34;</span>)
</span></span><span style=display:flex><span>	contextedMux <span style=color:#719e07>:=</span> <span style=color:#268bd2>AddContext</span>(mux)
</span></span><span style=display:flex><span>	log.<span style=color:#268bd2>Fatal</span>(http.<span style=color:#268bd2>ListenAndServe</span>(<span style=color:#2aa198>&#34;:8085&#34;</span>, contextedMux))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/go/ rel=tag>go</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/algorithm/binarysearch/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Binarysearch</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/go/go-decorator-json/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>Go Decorator Json</p></a></div></nav><script src=https://utteranc.es/client.js repo=glepnir/glepnir.github.io issue-term=title theme=github-dark-orange crossorigin=anonymous async></script></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 glepnir.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>